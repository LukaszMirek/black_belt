function initializeFeedTooltip(){new Flowtooltip({el:".tooltip-public",pos:"bottom",classes:"tooltip"})}var API_BASE=CommonHelpers.baseUrl+"/social/feeditems/",social=social||{};social.nextPage=1,social.isFetching=!1,social.isFeedFiltering=!1,social.isFeedType="ALL_POSTS",social.isFeedOwner="FROM_EVERYONE",social.isCommenting=!1,social.isMoreItems=!0,initializeFeedTooltip(),$('[id="filterselector"], [id="filterownselector"]').on("change",function(){var e=$('select[id="filterselector"]').val(),i=$('select[id="filterownselector"]').val();$.ajax({type:"GET",url:jsRoutes.controllers.social.SocialTask.indexFilter(e,i).url}).done(function(a){social.isFeedFiltering=!0,social.isFeedType=e,social.isFeedOwner=i,$("#social-feed").html(a),initializeFeedTooltip()})}),social.like=function(e){$.ajax({type:"POST",url:API_BASE+e+"/likes",accepts:"application/json"}).done(function(e){social.updateLikeState(e)}).fail(function(e,i,a){$.flashMessage(Messages["error.unknown"],"error")})},social.unlike=function(e){$.ajax({type:"DELETE",url:API_BASE+e+"/likes",accepts:"application/json"}).done(function(e){social.updateLikeState(e)}).fail(function(e,i,a){$.flashMessage(Messages["error.unknown"],"error")})},social.updateLikeState=function(e){if(e&&e.feedItemId){$("#feed-like-count-"+e.feedItemId).text(e.likeCount);var i=$("#like-"+e.feedItemId).find(".feed-like-button");e.isLikedByMe?(i.addClass("liked"),i.removeClass("notliked")):(i.addClass("notliked"),i.removeClass("liked"))}},social.toggleLike=function(e,i){$(e).hasClass("liked")?social.unlike(i):social.like(i)},social.postComment=function(e,i){if(!i.hasClass("sending")){var a=i.val().trim();if(i.val(""),!social.isCommenting&&""!==a){i.addClass("sending");var t=i.parents(".coach-comments-wrapper").length>0,s=i.parents(".comment-tabs").length>0,o=API_BASE+e+(t?"/coachcomments":"/comments");$.ajax({type:"POST",url:o,cache:!1,data:JSON.stringify({text:a}),dataType:"json",contentType:"application/json; charset=utf-8"}).done(function(i){social.loadComments(e,t,s)}).fail(function(e,a,t){$.flashMessage(Messages["error.unknown"],"error"),i.removeClass("sending")}).always(function(){social.isCommenting=!1})}}},social.confirmDeleteComment=function(e,i,a,t){var s=API_BASE+e+"/comments/"+i+"/confirmationdialog?time="+(new Date).getMilliseconds();Modal.open(s,{style:"narrow",callback:function(e){var s=$(e).find(".modal-body");a&&s.addClass("coach-comments"),t&&s.addClass("tabbed"),s.delegate("a","click",social.handleClick),$(e).find(".preview").append($("[data-ui-comments-comment-id="+i+"]").html())}})},social.deleteComment=function(e,i,a,t){if(null!=i&&i.trim().length>0&&social.deletedCommentIds.indexOf(i)<0){var s=social.deletedCommentIds.push(i),o=API_BASE+e+"/comments/"+i;$.ajax({type:"DELETE",cache:!1,url:o,dataType:"json"}).done(function(i){Modal.close(),social.loadComments(e,a,t)}).fail(function(e,i,a){Modal.close(),$.flashMessage(Messages["error.unknown"],"error"),social.deletedCommentIds.splice(s-1)})}},social.deletedCommentIds=[],social.loadComments=function(e,i,a){var t={type:"GET",url:API_BASE+e+(i?"/coachcomments":"/comments")+"?size=ALL",cache:!1,dataType:"html",success:function(i){var t=$("#feed-comments-container-"+e);a&&(t=t.find(".tab-pane.active")),t.html(i),t.find("[type='text']").focus();var s=$(i).find("[data-ui-comments-comment-id]").length;social.updateCommentCount(e,s,a),$(".sending").removeClass("sending")},fail:function(e,i,a){$.flashMessage(Messages["error.unknown"],"error")}};$.ajax(t)},social.updateCommentCount=function(e,i,a){if(e){var t=$("#feed-comment-count-"+e);a&&(t=t.find(".comment-tabs-ul > .active .tab-feed-item-count")),t.text(i+" ")}},social.loadMoreFeed=function(){if(social.showSpinner(),!social.isFetching){social.isFetching=!0;var e=$("div[data-ts]"),i=e.first().attr("data-ts"),a=e.length;if(1==social.isFeedFiltering)$.ajax({type:"GET",url:jsRoutes.controllers.social.SocialTask.loadMoreOlderThanTimestampFilter(i,a,social.isFeedType,social.isFeedOwner).url}).done(function(e){$("#social-feed").append(e),initializeFeedTooltip(),social.isFeedFiltering=!0,social.isFeedType=social.isFeedType,social.isFeedOwner=social.isFeedOwner,social.hideSpinner(),social.isFetching=!1});else{var t=CommonHelpers.context.coach?CommonHelpers.baseUrl+"/feed/page/"+social.nextPage:"/feed/"+i+"?index="+a;$.ajax({type:"GET",url:t,cache:!1}).done(function(e){CommonHelpers.context.coach&&social.nextPage++,$("#social-feed").append(e),initializeFeedTooltip()}).fail(function(e,i,a){}).always(function(){social.hideSpinner(),social.isFetching=!1})}}},social.changeVisibility=function(e,i){social.doChangeVisibility(e,i)},social.doChangeVisibility=function(e,i){$.ajax({type:"POST",url:API_BASE+e+"/visibility?status="+i,cache:!1}).done(function(e){var a=social.findFeedNode(e.id),t=a.find("[feed-item-visibility='"+i+"']");a.find(".exercise-visibility").html(t.html()),"PUBLIC"==i&&0==e.id.indexOf("TRAINING_SESSION")?$.flashMessage(Messages["analyseview.session_privacy.mouseover"],"info"):$.flashMessage(Messages["analyseview.visibility.changed.success"],"success")}).fail(function(e,i,a){$.flashMessage(Messages["error.unknown"],"error")})},social.findFeedItemId=function(e){var i=$(e).parents(".feed-item-row").attr("feed-item-id");return i&&0!==i.length||(i=null),i},social.findFeedNode=function(e){var i=$("#"+e);return i&&0!==i.length||(i=null),i},social.handleKeyPress=function(e){if(13===e.which){e.preventDefault();var i=$(e.target),a=social.findFeedItemId(i);social.postComment(a,i)}},social.hideSpinner=function(){spinner.remove("#feed-loader")},social.showSpinner=function(){spinner.add("#feed-loader")},social.handleClick=function(e){var i=$(e.target),a=social.findFeedItemId(i);if(i.hasClass("icon icon-post")){e.preventDefault();var t=i.parent("a.ui-comments-btn-post");t.length>0&&t.trigger("click")}else if(i.hasClass("ui-comments-btn-post"))e.preventDefault(),social.postComment(a,i.closest(".comment-bg").find("[type='text']"));else if(i.hasClass("feed-like-button")||i.hasClass("icon icon-like"))e.preventDefault(),e.stopPropagation(),i.hasClass("icon icon-like")&&(i=i.parent()),social.toggleLike(i,a);else if(i.hasClass("ui-comments-show-all"))e.preventDefault(),social.loadComments(a,i.parents(".coach-comments-wrapper").length>0,i.parents(".comment-tabs").length>0);else if(i.parents("[feed-item-visibility]").length>0){e.preventDefault();var s=i.parents("[feed-item-visibility]").attr("feed-item-visibility");social.changeVisibility(a,s)}else if(i.hasClass("remove-post")){e.preventDefault();var o=i.parents(".feed-item-row").attr("feed-item-id"),n=i.parents(".comment-item").attr("data-ui-comments-comment-id");social.confirmDeleteComment(o,n,i.parents(".coach-comments-wrapper").length>0,i.parents(".comment-tabs").length>0)}else if(i.hasClass("ui-comments-modal-delete")){e.preventDefault();var a=i.attr("data-ui-comments-post-modal-id"),n=i.attr("data-ui-comments-comment-modal-id");social.deleteComment(a,n,i.parents(".coach-comments").length>0,i.parents(".tabbed").length>0),i.attr("data-ui-comments-post-modal-id",""),i.attr("data-ui-comments-comment-modal-id","")}else i.hasClass("ui-comments-modal-cancel")?(e.preventDefault(),Modal.close()):i.parent().hasClass("training shareButton")||i.hasClass("training shareButton")?(e.preventDefault(),i.parent().hasClass("training shareButton")&&(i=i.parent()),new TrainingSessionShareDialog(i.attr("data-id"),i.attr("data-service")).open()):i.parent().hasClass("activity shareButton")||i.hasClass("activity shareButton")?(e.preventDefault(),i.parent().hasClass("activity shareButton")&&(i=i.parent()),new ActivityShareDialog(i.attr("data-id"),i.attr("data-service")).open()):(i.parent().hasClass("socialMediaRegisterButton")||i.hasClass("socialMediaRegisterButton"))&&(e.preventDefault(),i.parent().hasClass("socialMediaRegisterButton")&&(i=i.parent()),window.location=i.attr("href"))},social.isScrolled=!1,social.initScroll=function(e){social.feedItemCount=e,$(window).scroll(function(){social.isScrolled=!0}),setInterval(function(){social.isMoreItems=0===$("#no-more-items").length,social.isMoreItems&&social.isScrolled&&(social.isScrolled=!1,$(window).scrollTop()+$(window).height()>=$(document).height()-300&&social.loadMoreFeed())},250)},Statistic=function(e,i,a,t){this.value=e,this.unit=i,this.label=a,this.icon=t},ShareDialog=function(e,i){this.service=i,this.objectId=e,this.onShown=function(){},this.submit=function(){}},ShareDialog.prototype.open=function(){var e=this;$('[data-toggle="dropdown"]').parent().removeClass("open"),Modal.open($(".js-social-share-dialog"),{callback:function(i){e.dialog=i,spinner.add(e.dialog.find("#share-modal-loader")),e.dialog.find(".ui-share-modal-cancel").unbind().bind("click",function(e){e.preventDefault(),Modal.close()}),e.dialog.find(".ui-share-modal-confirm").unbind().bind("click",function(i){i.preventDefault(),e.submit()}),e.dialog.find("#shareDialogHeading > span").text(Messages["common.share_to_n"].toString().format(e.service.toString().capitalize())),e.dialog.find("#message").addClass("hidden"),e.dialog.find("#routeMap").css("visibility","hidden"),e.dialog.find("#modal-wrapper").css("height",e.dialog[0].scrollHeight),e.onShown()}})},TrainingSessionShareDialog=function(e,i){function a(e,i){var a={zoom:3,minZoom:3,maxZoom:15,disableDefaultUI:!0,center:new google.maps.LatLng(0,-180),mapTypeId:google.maps.MapTypeId.TERRAIN},t=new google.maps.Polyline({strokeColor:CommonHelpers.routeBasicHighlightColor,strokeOpacity:1,strokeWeight:2,zIndex:2,path:i.coordinates}),s=new google.maps.Polyline({strokeColor:CommonHelpers.routeBackgroundColor,strokeOpacity:.7,strokeWeight:6,zIndex:1,path:i.coordinates}),o=new google.maps.LatLngBounds(new google.maps.LatLng(i.limits[1][0],i.limits[0][0]),new google.maps.LatLng(i.limits[1][1],i.limits[0][1])),n=new google.maps.Map(e[0],a),l=new google.maps.Marker({map:n,position:i.coordinates[0],shadow:null,icon:new google.maps.MarkerImage(AppGlobal.imagesUrl+"map_icons/map-_route-start.svg",new google.maps.Size(20,20),new google.maps.Point(0,0),new google.maps.Point(10,10))}),c=new google.maps.Marker({map:n,position:i.coordinates[i.coordinates.length-1],shadow:null,icon:new google.maps.MarkerImage(AppGlobal.imagesUrl+"map_icons/map-_route-end.svg",new google.maps.Size(20,20),new google.maps.Point(0,0),new google.maps.Point(10,10))});n.fitBounds(o),t.setMap(n),s.setMap(n),l.setMap(n),c.setMap(n)}function t(e){var i={route:null,statistics:[]};switch(e["og:type"]){case"fitness.course":e["fitness:duration:value"]&&i.statistics.push(new Statistic(CommonHelpers.getSecondsAsDuration(e["fitness:duration:value"]),"",Messages["common.duration"],"duration")),e["fitness:speed:value"]&&i.statistics.push(new Statistic(CommonHelpers.round(CommonHelpers.convertSpeedToImperialSpeed(CommonHelpers.convertMpsToKmh(e["fitness:speed:value"])),1).toFixed(1),"METRIC"==CommonHelpers.units?Messages["common.abbreviations.unitOfKilometersPerHour"]:Messages["common.abbreviations.unitOfMilesPerHour"],Messages["common.average_speed"],"speed")),e["fitness:pace:value"]&&i.statistics.push(new Statistic(CommonHelpers.speedToPace(CommonHelpers.convertSecondsPerMeterToSpeed(e["fitness:pace:value"])),"METRIC"==CommonHelpers.units?Messages["common.abbreviations.unitOfMinutesPerKilometer"]:Messages["common.abbreviations.unitOfMinutesPerMile"],Messages["common.average_pace"],"speed")),e["fitness:distance:value"]&&i.statistics.push(new Statistic(CommonHelpers.round(e["fitness:distance:value"],2),"METRIC"==CommonHelpers.units?Messages["common.abbreviations.unitOfKilometers"]:Messages["common.abbreviations.unitOfMiles"],Messages["common.distance"],"distance")),e["fitness:calories"]&&i.statistics.push(new Statistic(e["fitness:calories"],Messages["common.abbreviations.unitOfKcal"],Messages["common.calories"],"calories")),e["fitness:custom_unit_energy:value"]&&void 0==e["fitness:calories"]&&i.statistics.push(new Statistic(CommonHelpers.round(e["fitness:custom_unit_energy:value"],0),"W",Messages["bikepower.analysisview.power.values.average_power"],"power")),i.route=s(e["fitness:metrics"],"location:"),i.statistics=i.statistics.slice(0,4);break;case"polar-flow:exercise":}return i}function s(e,i){var a=null;return e&&(a={coordinates:[],limits:[],center:[]},_.each(e,function(e){a.coordinates.push(new google.maps.LatLng(e[i+"latitude"],e[i+"longitude"]))}),a.limits=[[_.min(a.coordinates,function(e){return e.lng()}).lng(),_.max(a.coordinates,function(e){return e.lng()}).lng()],[_.min(a.coordinates,function(e){return e.lat()}).lat(),_.max(a.coordinates,function(e){return e.lat()}).lat()]],a.center=[(a.limits[0][0]+a.limits[0][1])/2,(a.limits[1][0]+a.limits[1][1])/2]),a}ShareDialog.call(this,e,i),this.statisticTemplate=_.template('<% _.each(items, function(item, i) { %><div class="col-sm-6 col-xs-12 basic-data-panel__item"><div class="basic-data-panel__item-wrapper"><svg class="basic-data-panel__icon"><use xlink:href="#icon-ci_<%= item.icon %>"></use></svg><div class="basic-data-panel__value"><span class="basic-data-panel__value-container"><%= item.value %></span><span class="basic-data-panel__value-unit">&nbsp;<%= item.unit %></span></div><div class="basic-data-panel__label"><%= item.label %></div></div></div><% }); %>'),this.articleTemplate=_.template('<div class="share-modal__training-image"><img src="<%= item.image %>"/></div><div class="share-modal__training-description"><p><%= item.title %></p></div>'),this.onShown=function(){if("object"==typeof google&&"object"==typeof google.maps)this.loadVisibility(),this.loadObjectData();else{var e=this;$.getScript(CommonHelpers.googleScript,function(i,a,t){e.loadVisibility(),e.loadObjectData()})}},this.submit=function(){var e=this,a=e.dialog.find(".ui-share-modal-confirm");spinner.add(a),a.attr("disabled",!0),$.ajax({url:jsRoutes.controllers.social.SocialTask.shareTrainingSession(e.objectId).url,method:"POST",data:JSON.stringify({id:e.objectId,message:e.dialog.find("#message").val(),service:i}),contentType:"application/json; charset=utf-8",dataType:"json"}).done(function(i){i&&i.redirect?window.location=i.redirect:($.flashMessage(Messages["common.shared_to_n_successfully"].toString().format(e.service.toString().capitalize()),"success"),Modal.close())}).fail(function(){}).always(function(){spinner.reset(a),a.attr("disabled",!1)})},this.loadVisibility=function(){var e=this;$.ajax({type:"GET",url:jsRoutes.controllers.social.SocialTask.getFeedItemVisibility(this.objectId).url}).done(function(i){if(i&&i.visibility){"public"!=i.visibility.toLowerCase()?e.dialog.find("#visibilityInfo").removeClass("hidden"):e.dialog.find("#visibilityInfo").addClass("hidden")}})},this.loadObjectData=function(){var e=this;$.ajax(jsRoutes.controllers.social.SocialTask.openGraphTrainingSession(e.objectId).url).done(function(i){var a=JSON.parse(i),s=t(a);s.statistics&&s.statistics.length>0?e.drawObject(s):e.drawArticle(a)}).fail(function(){Modal.close(),$.flashMessage(Messages["error.unknown"],"error")}).always(function(){spinner.remove(e.dialog.find("#share-modal-loader")),e.dialog.find("#message").removeClass("hidden"),e.dialog.find("#modal-wrapper").css("height","auto")})},this.drawObject=function(e){if(e.statistics&&e.statistics.length>0){var i="",t="";e.statistics.length<4?i+=this.statisticTemplate({items:e.statistics}):(t=document.createElement("div"),t.className="row basic-data-panel__row",t.innerHTML=this.statisticTemplate({items:e.statistics.slice(0,2)}),i+=t.outerHTML,t=document.createElement("div"),t.className="row basic-data-panel__row",t.innerHTML=this.statisticTemplate({items:e.statistics.slice(2,4)}),i+=t.outerHTML),this.dialog.find("#shareContent").addClass("basic-data-panel__header basic-data-panel__header--share").append(i)}e.route?(this.dialog.find("#routeMap").css("visibility","visible"),a(this.dialog.find("#routeMap"),e.route)):this.dialog.find("#routeMap").hide()},this.drawArticle=function(e){var i={image:e["og:image"],title:e["og:title"]};this.dialog.find("#routeMap").hide(),this.dialog.find("#shareContent").append($("<div class='share-modal__training-info'>").html(this.articleTemplate({item:i})))}},TrainingSessionShareDialog.prototype=Object.create(ShareDialog.prototype),TrainingSessionShareDialog.bind=function(e){$(e).on("click",function(e){new TrainingSessionShareDialog($(this).attr("data-id"),$(this).attr("data-service")).open()})},ActivityShareDialog=function(e,i){ShareDialog.call(this,e,i),this.objectType="activity",this.articleTemplate=_.template('<div class="share-modal__training-image"><img src="<%= item.image %>"/></div>'),this.onShown=function(){var e=this;$.ajax({type:"GET",url:jsRoutes.controllers.social.SocialTask.getFeedItemVisibility(this.objectId).url}).done(function(i){if(i&&i.visibility){"public"!==i.visibility.toLowerCase()?e.dialog.find("#visibilityInfo").removeClass("hidden"):e.dialog.find("#visibilityInfo").addClass("hidden")}});var i={image:"/image-generation/activity/"+e.objectId};e.dialog.find("#shareContent").append($("<div class='share-modal__training-info'>").html(e.articleTemplate({item:i}))),e.dialog.find("#routeMap").hide(),spinner.remove(e.dialog.find("#share-modal-loader")),e.dialog.find("#message").removeClass("hidden"),e.dialog.find("#modal-wrapper").css("height","auto"),e.dialog.hasClass("overlay")&&e.dialog.find(".share-modal__training-image > img").css("height","240px")},this.submit=function(){var e=this,a=e.dialog.find(".ui-share-modal-confirm");spinner.add(a),a.attr("disabled",!0),$.ajax({url:jsRoutes.controllers.social.SocialTask.shareActivity(e.objectId).url,method:"POST",data:JSON.stringify({id:e.objectId,message:e.dialog.find("#message").val(),service:i}),contentType:"application/json; charset=utf-8",dataType:"json"}).done(function(i){i&&i.redirect?window.location=i.redirect:($.flashMessage(Messages["common.shared_to_n_successfully"].toString().format(e.service.toString().capitalize()),"success"),Modal.close())}).fail(function(){}).always(function(){spinner.reset(a),a.attr("disabled",!1)})}},ActivityShareDialog.prototype=Object.create(ShareDialog.prototype),ActivityShareDialog.bind=function(e){$(e).on("click",function(e){new ActivityShareDialog($(this).attr("data-id"),$(this).attr("data-service")).open()})};
//# sourceMappingURL=social.min.js.map