Laps=function(){this.currentExerciseId=null,this.currentExeInfos=null,this.dataIndex=0,this.selectedLapIndex=null,this.lapDiv=$("body").find("#lapDiv"),this.pagingIndicator=$("body").find("#lap-paging-indicator-container"),this.currentLapsData=null,this.currentActiveLapsArray=null,this.swimmingShown=!1,this.phasesShown=!1,this.phaseCounter=0,this.type=null,this.phases=null,this.hills=null,this.loaded=!1,this.hasLapsAndPhases=!1,this.hasSamplesVisible=!0,this.lastAddedLapIndex=null,this.selectedData=null,this.performanceTestData=null},Laps.lapType={generated:{value:0,name:"gen"},manual:{value:1,name:"man"},auto:{value:2,name:"auto"},swimming:{value:3,name:"swimming"},phases:{value:4,name:"phases"},strength:{value:5,name:"strength"},hills:{value:6,name:"hills"},perfTest:{value:7,name:"perfTest"}},Laps.prototype.init=function(e){var a=this;this.createClickEvents(),e(),$.dispatcher.on("store.dataLoaded",function(e,a){a.isSingleSport&&(this.setPhases(store.getPhasesData()),this.SelectExercise(store.getSelectedExercise().id))}.bind(this)),$.dispatcher.on("sportList.selectSport",function(e,a){this.SelectExercise(a.exerciseId)}.bind(this)),$.dispatcher.on("sportList.unselectSport",function(e,a){this.UnselectExercise(a.exerciseId)}.bind(this)),$.dispatcher.on("rangeSelector.selectRange",function(e,a){this.updateDurationRangeSelector(a)}.bind(this)),$.dispatcher.on("rangeSelector.unSelectRange",function(e,a){this.resetLapHighlight()}.bind(this)),$.dispatcher.on("rangeStatistics.selectRange",function(e,a){this.updateDurationRangeSelector(a)}.bind(this)),$.dispatcher.on("rangeStatistics.unSelectRange",function(e,a){this.resetLapHighlight()}.bind(this)),$.dispatcher.on("rangeStatistics.saveLap",function(e,a){this.saveLapDataAndRenderPage()}.bind(this)),$.dispatcher.on("rangeStatistics.deleteLap",function(e,a){this.removeLap()}.bind(this)),$.dispatcher.on("superGraph.selectPhase",function(e,a){this.SelectLap("graph",a.index,!1)}.bind(this)),$.dispatcher.on("superGraph.selectSwimmingPhase",function(e,a){this.SelectLap("swimming",void 0,!0,a.index)}.bind(this)),$.dispatcher.on("superGraph.selectLap",function(e,a){this.type===Laps.lapType.perfTest?this.SelectPerformanceTestPhase(a.index):this.SelectLap("graph",a.index,!1)}.bind(this)),$.dispatcher.on("superGraph.rangeChanged",function(e,s){s.range.lapIndex===-1&&a.resetLapHighlight()}),$(window).resize(this.anchorHeaderToTop.bind(this))},Laps.prototype.setPhases=function(e){this.phases=e,this.buildPhasesData()},Laps.prototype.SelectExercise=function(e){var a=this;return this.clearLaps(),this.currentExerciseId=e,this.selectedData=null!==this.currentExerciseId?_.where(store.getTrainingSession().exercises,{id:parseInt(e)})[0]:store.getTrainingSession(),this.currentExeInfos=store.getLapData(),this.hills=store.getHillDataForExercise(e),this.performanceTestData=store.getPerformanceTestData(),this.currentExeInfos.lapExercises.filter(function(a){return a.exerciseId===Number(e)}).forEach(function(e){e.hasHillLaps=a.hills&&a.hills.length>0}),this.hasLapsAndPhases=this.doesExerciseHaveLapsAndPhases(this.currentExeInfos.lapExercises),this.setLapsSectionVisibility(!0,e,this.currentExeInfos.lapExercises),!1},Laps.prototype.UnselectExercise=function(e){return this.clearLaps(),this.currentExerciseId=null,this.selectedData=store.getTrainingSession(),this.currentExeInfos=null,this.setLapsSectionVisibility(!1),!1},Laps.prototype.doesExerciseHaveLapsAndPhases=function(e){if(!e)return!1;var a=e;for(var s in a)if(a[s].exerciseId==this.currentExerciseId)return"PHASED"===a[s].exerciseTargetType&&(a[s].hasAutoLaps||a[s].hasManualLaps||a[s].hasGeneratedLaps)},Laps.prototype.setLapsSectionVisibility=function(e,a,s){function i(e,a){e?(a.show(),l=a,r=!0):a.hide()}var t=this,l=null,n=$("#LapsTable");n.attr("style",""),e?n.removeClass("hide").addClass("show"):n.removeClass("show").addClass("hide"),this.hasSamplesVisible=e;var r=!1;for(var p in s)s[p].exerciseId===Number(a)&&(i(s[p].hasGeneratedLaps,$("#generatedlapsTab")),i(!s[p].isSwimmingExercise,$("#lapGenerationListHandle")),i("PHASED"===s[p].exerciseTargetType||"STRENGTH"===s[p].exerciseTargetType,$("#phasesTab")),i(s[p].hasAutoLaps,$("#autoLapsTab")),i(s[p].hasManualLaps,$("#lapsTab")),i(s[p].hasHillLaps,$("#hillTab")));if(!$.isEmptyObject(this.phases))for(var p in this.phases)Number(p)===a&&(i(this.phases[p].hasPhases,$("#swimmingTab")),t.swimmingShown=Boolean(this.phases[p].hasPhases));if(i(t.swimmingShown,$("#swimmingTab")),i(this.performanceTestData,$("#perfTestTab")),r){l&&"#lapGenerationListHandle"!==l.selector?($("#lapTabsHeader").find(".first").toArray().forEach(function(e){$(e).removeClass("first")}),l.parent().removeClass("active"),l.trigger("click"),l.addClass("first")):$("#lapGenerationListHandle").addClass("first");var c=$("#lapTabsHeader li:visible");c.removeClass("tab-break"),c&&c.length>2&&$(c.get(2)).addClass("tab-break")}else n.removeClass("show").addClass("hide")},Laps.prototype.clearLaps=function(){this.lapDiv.html(""),this.pagingIndicator.html(""),this.dataIndex=0,this.swimmingShown=!1,this.phasesShown=!1,this.selectedLapIndex=null,this.currentActiveLapsArray=null,this.hasLapsAndPhases=!1,this.lastAddedLapIndex=null,this.currentLapsData=[]},Laps.prototype.hasStats=function(e,a){var s=a.split(".");for(key in e)if(function(a){return 1===s.length?e[a][s[0]]:2===s.length&&e[a][s[0]]?e[a][s[0]][s[1]]:3===s.length&&e[a][s[0]]&&e[a][s[0]][s[1]]?e[a][s[0]][s[1]][s[2]]:void 0}(key))return!0;return!1},Laps.prototype.renderLaps=function(e,a,s){var i=this.getLapText(e),t=!0,l="",n="",r="",p="",c="",d="",o=this.hasStats(a,"cadence.max"),h=this.hasStats(a,"cadence.avg"),m=this.hasStats(a,"power.max"),u=this.hasStats(a,"power.avg"),v=this.hasStats(a,"speed.max"),g=this.hasStats(a,"speed.avg"),T=this.hasStats(a,"strideLength"),y=this.hasStats(a,"heartRate.max"),L=this.hasStats(a,"heartRate.avg"),f=this.hasStats(a,"trainingPeaksStatistic.normalizedPower"),S=this.hasStats(a,"trainingPeaksStatistic.intensityFactor"),w=this.hasStats(a,"trainingPeaksStatistic.trainingStressScore");this.lapDiv.html("");var x=this.getCurrentExerciseInfo();x.isSwimmingExercise===!0&&x.poolUnits?"METERS"!==x.poolUnits&&(t=!1):"METRIC"!==CommonHelpers.units&&(t=!1),t?(l=Messages["common.abbreviations.unitOfKilometers"],n=Messages["common.abbreviations.unitOfMeters"],r=Messages["common.abbreviations.unitOfKilometersPerHour"],p=Messages["common.abbreviations.unitOfMinutesPerKilometer"]):(l=Messages["common.abbreviations.unitOfMiles"],n=Messages["common.abbreviations.unitOfFeet"],r=Messages["common.abbreviations.unitOfMilesPerHour"],p=Messages["common.abbreviations.unitOfMinutesPerMile"]),x.isSwimmingExercise===!0?t?(c=Messages["diary.result.swimming_indoor.pace_avg"],l=Messages["common.abbreviations.unitOfMeters"],d=Messages["analyseview.lap.max_pace_header"]+" ["+Messages["diary.result.swimming_indoor.min_per_100_m"]+"]"):(c=Messages["diary.result.swimming_indoor.pace_avg_imperial"],l=Messages["diary.result.swimming_indoor.unitOfYards"],d=Messages["analyseview.lap.max_pace_header"]+" ["+Messages["diary.result.swimming_indoor.min_per_100_yd"]+"]"):(c=Messages["analyseview.lap.avg_pace_header"],d=Messages["analyseview.lap.max_pace_header"]);var M="<div class='lap-table'>";M+="<div class='lap-row lap-th'>",M+='<div class="lap-cell static-cell static-header">'+Messages["analyseview.lap.number_header"]+"</div>",this.type===Laps.lapType.hills&&(M+="<div class='lap-cell static-cell static-header'>"+Messages["trainingTarget.phase.noun"]+"</div> "),M+="<div class='lap-cell static-cell static-header'>"+Messages["analyseview.lap.duration_header"]+"</div>",this.hasSamplesVisible===!0?(M+="<div class='lap-cell static-cell static-header'>"+Messages["analyseview.lap.distance_header"]+"</div>",M+=this.type===Laps.lapType.hills?"<div class='lap-cell static-cell static-header'>"+Messages["analyseview.ascent"]+" / "+Messages["analyseview.descent"]+"</div>":"<div class='lap-cell static-cell static-header'>"+Messages["analyseview.lap.avg_hr_header"]+"</div>"):(M+="<div class='lap-cell static-cell static-header'>"+Messages["analyseview.lap.split_duration_header"]+"</div>",M+="<div class='lap-cell static-cell static-header'></div>");var _=[],b=[];if(a[0]&&u&&m&&this.hasSamplesVisible===!0&&(_.push("<div class='lap-cell'>"+Messages["bikepower.analysisview.lap.power.data_power_avg"]+"</div>"),b.push("<li></li>"),_.push("<div class='lap-cell'>"+Messages["bikepower.analysisview.lap.power.data_power_max"]+"</div>"),b.push("<li></li>")),f&&(_.push("<div class='lap-cell trainingpeaks-data-item-laps'>"+Messages["common.TP.short_normalized_power"]+"</div>"),b.push("<li></li>")),S&&(_.push("<div class='lap-cell trainingpeaks-data-item-laps'>"+Messages["common.TP.short_intensity_factor"]+"</div>"),b.push("<li></li>")),w&&(_.push("<div class='lap-cell trainingpeaks-data-item-laps'>"+Messages["common.TP.short_training_stress_score"]+"</div>"),b.push("<li></li>")),this.hasSamplesVisible===!0){g&&(s?x.isSwimmingExercise===!0?(_.push("<div class='lap-cell'>"+c+"</div>"),b.push("<li></li>")):(_.push("<div class='lap-cell'>"+Messages["analyseview.lap.avg_speed_header"]+"</div>"),b.push("<li></li>")):(_.push("<div class='lap-cell'>"+c+"</div>"),b.push("<li></li>"))),v&&(s?x.isSwimmingExercise===!0?x.hasSwimmingSamples===!1&&(_.push("<div class='lap-cell'>"+d+"</div>"),b.push("<li></li>")):(_.push("<div class='lap-cell'>"+Messages["analyseview.lap.max_speed_header"]+"</div>"),b.push("<li></li>")):(_.push("<div class='lap-cell'>"+d+"</div>"),b.push("<li></li>"))),L&&this.type===Laps.lapType.hills&&(_.push("<div class='lap-cell'>"+Messages["analyseview.lap.avg_hr_header"]+"</div>"),b.push("<li></li>")),y&&(_.push("<div class='lap-cell'>"+Messages["analyseview.lap.max_hr_header"]+"</div>"),b.push("<li></li>")),x.hasSwimmingSamples===!1?(o&&h&&(x.isSwimmingExercise===!0?(_.push("<div class='lap-cell'>"+Messages["open.water.swimming.stroke_rate_avg"]+"</div>"),b.push("<li></li>"),_.push("<div class='lap-cell'>"+Messages["open.water.swimming.progress.curve.maximum_stroke_rate"]+" ["+Messages["open.water.swimming.strokes_min"]+"]</div>"),b.push("<li></li>")):(_.push("<div class='lap-cell'>"+Messages["analyseview.lap.avg_cadence_header"]+"</div>"),b.push("<li></li>"),_.push("<div class='lap-cell'>"+Messages["analyseview.lap.max_cadence_header"]+"</div>"),b.push("<li></li>"))),T&&(_.push("<div class='lap-cell'>"+Messages["analyseview.lap.avg_stride_length_header"]+"</div>"),b.push("<li></li>"))):(_.push("<div class='lap-cell'>"+Messages["diary.result.swimming_indoor.strokes_avg"]+"</div>"),b.push("<li></li>"),_.push("<div class='lap-cell'>"+Messages["diary.result.swimming_indoor.strokes_minute"]+"</div>"),b.push("<li></li>"),_.push("<div class='lap-cell'>"+Messages["diary.result.swimming_indoor.swolf_avg"]+"</div>"),b.push("<li></li>")),_.push("<div class='lap-cell'>"+Messages["analyseview.lap.split_distance_header"]+"</div>"),b.push("<li></li>"),_.push("<div class='lap-cell'>"+Messages["analyseview.lap.split_duration_header"]+"</div>"),b.push("<li></li>"),this.type===Laps.lapType.hills&&(_.push("<div class='lap-cell'>"+Messages["common.avg_incline"]+" / "+Messages["common.avg_decline"]+"</div>"),b.push("<li></li>"));for(var C=this.dataIndex,D=0;D<4;D++)M+=_[C],b[C]="<li class='visible-cell'></li>",C=(C+1)%_.length}M+="</div>";for(var E=0,A=0,P=0;P<a.length;P++){var H=null!=a[P].duration.millis&&void 0!==a[P].duration.millis?a[P].duration.millis:0,I=void 0!==a[P].distance&&null!=a[P].distance?a[P].distance:0;0!==I&&this.type===Laps.lapType.hills&&(I=t?CommonHelpers.round(I,0):CommonHelpers.round(CommonHelpers.convertMetersToFeet(I),0));var $=0,R=0;void 0!==a[P].speed&&null!=a[P].speed&&(x.isSwimmingExercise===!1?($=CommonHelpers.convertSpeedToImperialSpeed(a[P].speed.avg),R=CommonHelpers.convertSpeedToImperialSpeed(a[P].speed.max)):t?($=CommonHelpers.convertSpeedToSwimmingPace(a[P].speed.avg,"METRIC"),R=CommonHelpers.convertSpeedToSwimmingPace(a[P].speed.max,"METRIC")):($=CommonHelpers.convertSpeedToSwimmingPace(a[P].speed.avg,"IMPERIAL"),R=CommonHelpers.convertSpeedToSwimmingPace(a[P].speed.max,"IMPERIAL")));var k=0,N=0;void 0!==a[P].cadence&&null!=a[P].cadence&&(k=null!=a[P].cadence.avg?a[P].cadence.avg:0,N=null!=a[P].cadence.max?a[P].cadence.max:0);var O=0;void 0!==a[P].strideLength&&null!=a[P].strideLength&&(O=CommonHelpers.round(CommonHelpers.convertCentimetersToInches(a[P].strideLength.avg),1));var V=0;void 0!==a[P].ascentDescent&&null!=a[P].ascentDescent&&(V=t?CommonHelpers.round(a[P].ascentDescent,0):CommonHelpers.round(CommonHelpers.convertMetersToFeet(a[P].ascentDescent),0));var U=0,F=0;void 0!==a[P].heartRate&&null!=a[P].heartRate&&"null"!==a[P].heartRate&&(U=a[P].heartRate.avg,F=a[P].heartRate.max);var B=null,G=null;if(void 0!==a[P].power&&null!=a[P].power){var Y=ParameterManager.get("powerUnit").decimals;B=void 0!==a[P].power.avg&&null!=a[P].power.avg?CommonHelpers.round(a[P].power.avg*ParameterManager.get("powerUnit").factor,Y).toFixed(Y):0,G=void 0!==a[P].power.max&&null!=a[P].power.max?CommonHelpers.round(a[P].power.max*ParameterManager.get("powerUnit").factor,Y).toFixed(Y):0}var j=null,W=null,K=null;void 0!==a[P].trainingPeaksStatistic&&null!=a[P].trainingPeaksStatistic&&(void 0!==a[P].trainingPeaksStatistic.normalizedPower&&null!=a[P].trainingPeaksStatistic.normalizedPower&&(j=a[P].trainingPeaksStatistic.normalizedPower),void 0!==a[P].trainingPeaksStatistic.intensityFactor&&null!=a[P].trainingPeaksStatistic.intensityFactor&&(W=CommonHelpers.round(a[P].trainingPeaksStatistic.intensityFactor,2).toFixed(2)),void 0!==a[P].trainingPeaksStatistic.trainingStressScore&&null!=a[P].trainingPeaksStatistic.trainingStressScore&&(K=CommonHelpers.round(a[P].trainingPeaksStatistic.trainingStressScore,1).toFixed(1)));var z=null;if(this.type===Laps.lapType.hills)switch(a[P].hillPhase){case"DOWNHILL":z=Messages["hill_splitter.training_analysis_view.breakdown.downhill_number"].replace("{0}",a[P].hillNumber);break;case"UPHILL":z=Messages["hill_splitter.training_analysis_view.breakdown.uphill_number"].replace("{0}",a[P].hillNumber);break;case"FLAT":default:z=Messages["hill_splitter.training_analysis_view.breakdown.flat"]}A+=H,a[P].splitDuration=A,M+="<div type='"+e.name+"' lap_index='"+a[P].lapNumber+"' class='lap-row "+i+"RowDiv' id='"+i+"Div_"+a[P].lapNumber+"'>",M+="<div class='lap-cell static-cell'>"+Number(a[P].lapNumber+1)+"</div>",this.type===Laps.lapType.hills&&(M+="<div class='lap-cell static-cell'>"+z+"</div>"),M+="<div class='lap-cell static-cell'><div style='width: 100%;'><div class='time'>"+CommonHelpers.getMillisAsDurationWithTenthOfSeconds(H)+"</div></div></div>";var X=[];if(this.hasSamplesVisible===!0){if(x.hasSwimmingSamples===!1){var Z=a[P].distance;x.isSwimmingExercise?("YARDS"===x.poolUnits&&(Z=CommonHelpers.metersToYards(Z)),Z=CommonHelpers.round(Z,0)):Z=this.type===Laps.lapType.hills?I:Converter.Distance.convertForView(a[P].distance),M+=this.type===Laps.lapType.hills?"<div class='lap-cell static-cell'>"+Z+" "+n+"</div>":"<div class='lap-cell static-cell'>"+Z+" "+l+"</div>",void 0!==a[P].distance&&(E+=Number(a[P].distance))}else{var J=null!=a[P].distance?a[P].distance:"";"YARDS"===x.poolUnits&&(J=CommonHelpers.metersToYards(J)),void 0!==a[P].distance&&(E+=Number(J)),J=Math.floor(J),J=J.toString().replace(",","."),M+="<div class='lap-cell static-cell'>&nbsp;"+J+" "+l+"</div>"}if(M+=this.type===Laps.lapType.hills?"FLAT"===a[P].hillPhase?"<div class='lap-cell static-cell'> - </div>":"<div class='lap-cell static-cell'>"+V+" "+n+"</div>":"<div class='lap-cell static-cell'>"+U+" "+Messages["common.abbreviations.unitOfHeartbeat"]+"</div>",u&&X.push("<div class='lap-cell'>"+B+" "+ParameterManager.get("powerUnit").msg+"</div>"),m&&X.push("<div class='lap-cell'>"+G+" "+ParameterManager.get("powerUnit").msg+"</div>"),f&&X.push("<div class='lap-cell'>"+j+"</div>"),S&&X.push("<div class='lap-cell'>"+W+"</div>"),w&&X.push("<div class='lap-cell'>"+K+"</div>"),g&&(x.isSwimmingExercise?x.hasSwimmingSamples?"YARDS"===x.poolUnits?X.push("<div class='lap-cell'>"+DateUtils.getMinutesAsText(CommonHelpers.convertSwimmingMetricPaceToSwimmingYardsPace(a[P].swimmingPacePerDistance))+"</div>"):X.push("<div class='lap-cell'>"+DateUtils.getMinutesAsText(a[P].swimmingPacePerDistance)+"</div>"):X.push("<div class='lap-cell'>"+DateUtils.getMinutesAsText($)+"</div>"):s?X.push("<div class='lap-cell'>"+CommonHelpers.round($,1)+" "+r+"</div>"):X.push("<div class='lap-cell'>"+CommonHelpers.speedToPace($)+" "+p+"</div>")),v&&(x.isSwimmingExercise?x.hasSwimmingSamples||X.push("<div class='lap-cell'>"+DateUtils.getMinutesAsText(R)+"</div>"):s?X.push("<div class='lap-cell'>"+CommonHelpers.round(R,1)+" "+r+"</div>"):X.push("<div class='lap-cell'>"+CommonHelpers.speedToPace(R)+" "+p+"</div>")),L&&this.type===Laps.lapType.hills&&X.push("<div class='lap-cell'>"+U+" "+Messages["common.abbreviations.unitOfHeartbeat"]+"</div>"),y&&X.push("<div class='lap-cell'>"+F+" "+Messages["common.abbreviations.unitOfHeartbeat"]+"</div>"),x.hasSwimmingSamples===!1?(o&&h&&(X.push("<div class='lap-cell'>"+k+"</div>"),X.push("<div class='lap-cell'>"+N+"</div>")),T&&X.push("<div class='lap-cell'>"+O+"</div>")):(X.push("<div class='lap-cell'>"+a[P].swimmingStrokePerLength+"</div>"),X.push("<div class='lap-cell'>"+a[P].swimmingSpm+"</div>"),X.push("<div class='lap-cell'>"+a[P].swimmingAvgSwolf+"</div>")),x.isSwimmingExercise===!1)X.push("<div class='lap-cell'>"+Converter.Distance.convertForView(E)+" "+l+"</div>");else{var J=null!=E?E:"";J=Math.floor(J),J=J.toString().replace(",","."),X.push("<div class='lap-cell'>"+J+" "+l+"</div>")}X.push("<div class='lap-cell'>"+CommonHelpers.getMillisAsDurationWithTenthOfSeconds(A)+"</div>"),this.type===Laps.lapType.hills&&("FLAT"===a[P].hillPhase?X.push("<div class='lap-cell'> - </div>"):X.push("<div class='lap-cell'>"+CommonHelpers.round(a[P].angleAvg,0)+" &percnt;</div>")),C=this.dataIndex;for(var D=0;D<4;D++)M+=X[C],C=(C+1)%X.length}else M+="<div class='lap-cell'>"+CommonHelpers.getMillisAsDurationWithTenthOfSeconds(A)+"</div><div class='lap-cell'></div>";M+="</div>"}M+="</div>",this.lapDiv.html(M),this.pagingIndicator.html(b),this.createLapSelectClickEvent(e),this.showRestOfLapData(e,_.length-1),this.anchorHeaderToTop(),this.includeColumnBreakdownClassIntoTableControls()},Laps.prototype.renderPhases=function(){var e=Laps.lapType.phases,a=this.getLapText(e),s=exerciseTargetResults[this.currentExerciseId].exercisePhasedTargetData,i=this.getCurrentExerciseInfo(),t=i.isTypeSpeed,l=this.hasStats(s,"statistics.cadence.max"),n=this.hasStats(s,"statistics.cadence.avg"),r=this.hasStats(s,"statistics.power.max"),p=this.hasStats(s,"statistics.power.avg"),c=this.hasStats(s,"statistics.speed.max"),d=this.hasStats(s,"statistics.speed.avg"),o=this.hasStats(s,"statistics.strideLength"),h=this.hasStats(s,"statistics.heartRate.max"),m=this.hasStats(s,"statistics.heartRate.avg");this.lapDiv.html("");var u=!0;i.isSwimmingExercise===!0&&i.poolUnits?"METERS"!==i.poolUnits&&(u=!1):"METRIC"!==CommonHelpers.units&&(u=!1);var v="";v=u?Messages["common.abbreviations.unitOfKilometers"]:Messages["common.abbreviations.unitOfMiles"];var g="";g=u?Messages["common.abbreviations.unitOfKilometersPerHour"]:Messages["common.abbreviations.unitOfMilesPerHour"];var T="";T=u?Messages["common.abbreviations.unitOfMinutesPerKilometer"]:Messages["common.abbreviations.unitOfMinutesPerMile"];i.hasSwimmingSamples===!0&&i.poolUnits&&(u?(Messages["diary.result.swimming_indoor.pace_avg"],v=Messages["common.abbreviations.unitOfMeters"]):(Messages["diary.result.swimming_indoor.pace_avg_imperial"],v=Messages["diary.result.swimming_indoor.unitOfYards"]));var y="<div class='lap-table'>";y+="<div class='lap-row lap-th'>",y+='<div class="lap-cell static-cell static-header">'+Messages["analyseview.lap.number_header"]+"</div>",y+="<div class='lap-cell static-cell static-header'>"+Messages["diary.phased.target.phase_name"]+"</div> ",y+="<div class='lap-cell static-cell static-header'>"+Messages["trainingTarget.phase.noun"]+"</div> ",y+="<div class='lap-cell static-cell static-header'>"+Messages["diary.phased.target.intensity"]+"</div> ";var L=[],f=[];if(this.hasSamplesVisible===!0){L.push("<div class='lap-cell''>"+Messages["analyseview.lap.duration_header"]+" </div>"),f.push("<li></li>"),L.push("<div class='lap-cell'>"+Messages["analyseview.lap.distance_header"]+"</div>"),f.push("<li></li>"),m&&(L.push("<div class='lap-cell'>"+Messages["analyseview.lap.avg_hr_header"]+"</div>"),f.push("<li></li>")),h&&(L.push("<div class='lap-cell'>"+Messages["analyseview.lap.max_hr_header"]+"</div>"),f.push("<li></li>")),L.push("<div class='lap-cell'>"+Messages["diary.phased.target.time_in_zone"]+"</div>"),f.push("<li></li>"),void 0!=s[0]&&p&&r&&(L.push("<div class='lap-cell'>"+Messages["bikepower.analysisview.lap.power.data_power_avg"]+"</div>"),f.push("<li></li>"),L.push("<div class='lap-cell'>"+Messages["bikepower.analysisview.lap.power.data_power_max"]+"</div>"),f.push("<li></li>")),!t&&d?(L.push("<div class='lap-cell'>"+Messages["analyseview.lap.avg_pace_header"]+"</div>"),f.push("<li></li>")):i.hasSwimmingSamples===!1&&d&&(L.push("<div class='lap-cell'>"+Messages["analyseview.lap.avg_speed_header"]+"</div>"),f.push("<li></li>")),!t&&c?(L.push("<div class='lap-cell'>"+Messages["analyseview.lap.max_pace_header"]+"</div>"),f.push("<li></li>")):i.hasSwimmingSamples===!1&&c&&(L.push("<div class='lap-cell'>"+Messages["analyseview.lap.max_speed_header"]+"</div>"),f.push("<li></li>")),i.hasSwimmingSamples===!1&&(l&&n&&(L.push("<div class='lap-cell'>"+Messages["analyseview.lap.avg_cadence_header"]+"</div>"),f.push("<li></li>"),L.push("<div class='lap-cell'>"+Messages["analyseview.lap.max_cadence_header"]+"</div>"),f.push("<li></li>")),o&&(L.push("<div class='lap-cell'>"+Messages["analyseview.lap.avg_stride_length_header"]+"</div>"),f.push("<li></li>"))),L.push("<div class='lap-cell'>"+Messages["analyseview.lap.split_distance_header"]+"</div>"),f.push("<li></li>"),L.push("<div class='lap-cell'>"+Messages["analyseview.lap.split_duration_header"]+"</div>"),f.push("<li></li>");for(var S=this.dataIndex,w=0;w<4;w++)y+=L[S],f[S]="<li class='visible-cell'></li>",S=(S+1)%L.length}y+="</div>";for(var x=0,M=0,_=0;_<s.length;_++){var b=null!=s[_].duration.millis&&void 0!==s[_].duration.millis?s[_].duration.millis:0;void 0!==s[_].distance&&(x+=Number(s[_].distance));var C=0,D=0;void 0!==s[_].statistics.speed&&null!=s[_].statistics.speed&&(C=CommonHelpers.convertSpeedToImperialSpeed(s[_].statistics.speed.avg),D=CommonHelpers.convertSpeedToImperialSpeed(s[_].statistics.speed.max));var E=0,A=0;void 0!==s[_].statistics.cadence&&null!=s[_].statistics.cadence&&(E=null!=s[_].statistics.cadence.avg?s[_].statistics.cadence.avg:0,A=null!=s[_].statistics.cadence.max?s[_].statistics.cadence.max:0);var P=0;void 0!==s[_].statistics.strideLength&&null!=s[_].statistics.strideLength&&(P=CommonHelpers.round(CommonHelpers.convertCentimetersToInches(s[_].statistics.strideLength.avg),1));var H=0,I=0;void 0!==s[_].statistics.heartRate&&null!=s[_].statistics.heartRate&&"null"!==s[_].statistics.heartRate&&(H=s[_].statistics.heartRate.avg,I=s[_].statistics.heartRate.max);var $=null,R=null;if(void 0!==s[_].statistics.power&&null!=s[_].statistics.power){var k=ParameterManager.get("powerUnit").decimals;$=void 0!==s[_].statistics.power.avg&&null!=s[_].statistics.power.avg?CommonHelpers.round(s[_].statistics.power.avg*ParameterManager.get("powerUnit").factor,k).toFixed(k):0,R=void 0!==s[_].statistics.power.max&&null!=s[_].statistics.power.max?CommonHelpers.round(s[_].statistics.power.max*ParameterManager.get("powerUnit").factor,k).toFixed(k):0}if(M+=b,s[_].splitDuration=M,y+="<div type='"+e.name+"' lap_index='"+s[_].lapNumber+"' class='lap-row "+a+"RowDiv' id='"+a+"Div_"+s[_].lapNumber+"'>",y+="<div class='lap-cell static-cell'>"+Number(s[_].lapNumber+1)+"</div>",y+="<div class='lap-cell static-cell'>"+s[_].name+"</div>","DURATION"===s[_].goalType)y+="<div class='lap-cell static-cell'>"+CommonHelpers.getSecondsAsDuration(s[_].duration.standardSeconds)+"</div>";else if(i.hasSwimmingSamples===!1)y+="<div class='lap-cell static-cell'>"+Converter.Distance.convertForView(s[_].distance)+" "+v+"</div>";else{var N=null!=s[_].distance?s[_].distance:"";"YARDS"===i.poolUnits&&(N=CommonHelpers.metersToYards(N)),N=Math.floor(N),N=N.toString().replace(",","."),y+="<div class='lap-cell static-cell'>"+N+" "+v+"</div>"}var O="";O="HEART_RATE_ZONES"===s[_].zoneType?Messages["analyseview.chart.settings.zones"]+" "+s[_].lowerZone+"-"+s[_].upperZone:"SPEED_ZONES"===s[_].zoneType?Messages["speed.zone.diary.phased.target.speed_zones"]+" "+s[_].lowerZone+"-"+s[_].upperZone:Messages["trainingTarget.intensity.NONE"],y+="<div class='lap-cell static-cell'>"+O+"</div>";var V=[];if(this.hasSamplesVisible===!0){if(V.push("<div class='lap-cell'><div style='width: 100%;'><div class='time'>"+CommonHelpers.getSecondsAsDuration(s[_].duration.standardSeconds)+"</div></div></div>"),i.hasSwimmingSamples===!1)V.push("<div class='lap-cell'>"+Converter.Distance.convertForView(s[_].distance)+" "+v+"</div>");else{var N=null!=s[_].distance?s[_].distance:"";"YARDS"===i.poolUnits&&(N=CommonHelpers.metersToYards(N)),N=Math.floor(N),N=N.toString().replace(",","."),V.push("<div class='lap-cell'>"+N+"</div>")}if(m&&V.push("<div class='lap-cell'>"+H+" "+Messages["common.abbreviations.unitOfHeartbeat"]+"</div>"),h&&V.push("<div class='lap-cell'>"+I+" "+Messages["common.abbreviations.unitOfHeartbeat"]+"</div>"),s[_].inZone?V.push("<div class='lap-cell'>"+CommonHelpers.getSecondsAsDuration(s[_].inZone.standardSeconds)+"</div>"):V.push("<div class='lap-cell'>00:00:00</div>"),p&&V.push("<div class='lap-cell'>"+$+" "+ParameterManager.get("powerUnit").msg+"</div>"),r&&V.push("<div class='lap-cell'>"+R+" "+ParameterManager.get("powerUnit").msg+"</div>"),!t&&d?V.push("<div class='lap-cell'>"+CommonHelpers.speedToPace(C)+" "+T+"</div>"):i.hasSwimmingSamples===!1&&d&&V.push("<div class='lap-cell'>"+CommonHelpers.round(C,1)+" "+g+"</div>"),!t&&c?V.push("<div class='lap-cell'>"+CommonHelpers.speedToPace(D)+" "+T+"</div>"):i.hasSwimmingSamples===!1&&c&&V.push("<div class='lap-cell'>"+CommonHelpers.round(D,1)+" "+g+"</div>"),i.hasSwimmingSamples===!1&&(l&&n&&(V.push("<div class='lap-cell'>"+E+"</div>"),V.push("<div class='lap-cell'>"+A+"</div>")),o&&V.push("<div class='lap-cell'>"+P+"</div>")),i.hasSwimmingSamples===!1)V.push("<div class='lap-cell'>"+Converter.Distance.convertForView(x)+" "+v+"</div>");else{var N=null!=x?x:"";N=Math.floor(N),N=N.toString().replace(",","."),V.push("<div class='lap-cell'>"+N+" "+v+"</div>")}V.push("<div class='lap-cell'>"+CommonHelpers.getMillisAsDurationWithTenthOfSeconds(M)+"</div>"),S=this.dataIndex;for(var w=0;w<4;w++)y+=V[S],S=(S+1)%V.length}else y+="<div class='lap-cell'>"+CommonHelpers.getMillisAsDurationWithTenthOfSeconds(M)+"</div><div class='lap-cell'></div>";y+="</div>"}y+="</div>",this.lapDiv.html(y),this.pagingIndicator.html(f),this.createLapSelectClickEvent(e),this.showRestOfLapData(e,L.length-1),this.anchorHeaderToTop(),this.includeColumnBreakdownClassIntoTableControls()},Laps.prototype.renderSwimmingPhases=function(e,a,s,i){var t,l=this.getLapText(e),n="",r="",p="",c=!1;for(t=0;t<a.summaries.length;t++)if(a.summaries[t].avgStroke>0){c=!0;break}"METERS"==a.poolUnits?(n=Messages["analyseview.paceAvg"],r=Messages["analyseview.lap.max_pace_header"],p=Messages["diary.result.swimming_indoor.min_per_100_m"]):(n=Messages["diary.result.swimming_indoor.pace_avg_imperial"],r=Messages["analyseview.lap.max_pace_header"],p=Messages["diary.result.swimming_indoor.min_per_100_yd"]);var d="<div class='lap-table swimming-phases-table'>";d+="<div class='lap-row lap-th'>",d+='<div class="lap-cell static-cell static-header">'+Messages["analyseview.lap.number_header"]+"</div>",d+="<div class='lap-cell static-cell static-header'>"+Messages["diary.result.swimming_indoor.style"]+"</div>",d+="<div class='lap-cell static-cell static-header'>"+Messages["analyseview.lap.distance_header"]+"</div>",d+="<div class='lap-cell static-cell static-header'>"+Messages["analyseview.lap.duration_header"]+"</div>";var o=[],h=[];o.push("<div class='lap-cell'>"+n+"</div>"),h.push("<li></li>"),o.push("<div class='lap-cell'>"+r+"</div>"),h.push("<li></li>"),o.push("<div class='lap-cell'>"+Messages["analyseview.lap.avg_hr_header"]+"</div>"),h.push("<li></li>"),o.push("<div class='lap-cell'>"+Messages["analyseview.lap.max_hr_header"]+"</div>"),h.push("<li></li>"),c&&(o.push("<div class='lap-cell'>"+Messages["diary.result.swimming_indoor.strokes_avg"]+"</div>"),h.push("<li></li>"),o.push("<div class='lap-cell'>"+Messages["open.water.swimming.stroke_rate_avg"]+"</div>"),h.push("<li></li>"),o.push("<div class='lap-cell'>"+Messages["diary.result.swimming_indoor.swolf_avg"]+"</div>"),h.push("<li></li>"));for(var m=this.dataIndex,u=0;u<4;u++)d+=o[m],h[m]="<li class='visible-cell'></li>",m=(m+1)%o.length;d+="</div>";var v=!0;this.phaseCounter=0;var g=0;for(t=0;t<a.phases.length;){var T=[],y=null,L=null;if(v===!0)null!=a.summaries&&null!=a.summaries[this.phaseCounter]&&v===!0&&(y=a.summaries[this.phaseCounter]),v=!1,null!=y&&(d+="<div type='"+e.name+"'"+(0===y.distance?" lap_index='"+t+"' ":"")+" class='lap-row swimming-phase "+l+"RowDiv' id='"+l+"Div_1' phaseindex = '"+this.phaseCounter+"' phasestate='collapsed'"+(0!==y.distance?" isGroupPhase='group' ":"")+" data-swimming-phase-index='"+g+"'>",0===y.distance?d+="<div class='lap-cell static-cell'></div>":(g++,d+="<div class='lap-cell button-lap-cell static-cell' style=' white-space: nowrap;'>",d+="<a class='btn btn-icon btn-xs' style='padding: 0px; margin-right: 5px;'>",d+="<i class='icon icon-arrow-right'></i></a>"+g+"</div>"),d+="<div class='lap-cell static-cell'>"+y.style+"</div>",d+="<div class='lap-cell static-cell'>"+Math.round(y.distance)+"</div>",d+="<div class='lap-cell static-cell'>"+CommonHelpers.getSecondsAsDuration(y.duration.millis/1e3)+"</div>",T.push("<div class='lap-cell'>"+DateUtils.getMinutesAsText(y.avgPace)+" "+p+"</div>"),T.push("<div class='lap-cell'>"+DateUtils.getMinutesAsText(y.maxPace)+" "+p+"</div>"),T.push("<div class='lap-cell'>"+Math.round(y.avgHeartRate)+" "+Messages["common.abbreviations.unitOfHeartbeat"]+"</div>"),T.push("<div class='lap-cell'>"+y.maxHeartRate+" "+Messages["common.abbreviations.unitOfHeartbeat"]+"</div>"),c&&(T.push("<div class='lap-cell'>"+Math.round(y.avgStroke)+"</div>"),T.push("<div class='lap-cell'>"+Math.round(y.avgSpm)+"</div>"),T.push("<div class='lap-cell'>"+Math.round(y.avgSwolf)+"</div>")));else{if(null!=a.phases[t]&&(L=a.phases[t]),"REST TIME"===L.style.toUpperCase()){t++,v=!0,this.phaseCounter++;continue}d+="<div type='"+e.name+"' lap_index='"+t+"' class='lap-row swimming-pool-length "+l+"RowDiv' id='"+l+"Div_1' phaseindex = '"+this.phaseCounter+"' style='display: none;'>",d+="<div class='lap-cell'></div>",d+="<div class='lap-cell'>"+L.style+"</div>",d+="<div class='lap-cell'>"+Math.round(L.distance)+"</div>",d+="<div class='lap-cell'>"+CommonHelpers.getSecondsAsDuration(L.duration.standardSeconds)+"</div>",T.push("<div class='lap-cell'>"+DateUtils.getMinutesAsText(L.avgPace)+" "+p+"</div>"),T.push("<div class='lap-cell'>"+DateUtils.getMinutesAsText(L.maxPace)+" "+p+"</div>"),T.push("<div class='lap-cell'>"+Math.round(L.avgHeartRate)+" "+Messages["common.abbreviations.unitOfHeartbeat"]+"</div>"),T.push("<div class='lap-cell'>"+L.maxHeartRate+" "+Messages["common.abbreviations.unitOfHeartbeat"]+"</div>"),T.push("<div class='lap-cell'>"+Math.round(L.avgStroke)+"</div>"),T.push("<div class='lap-cell'>"+Math.round(L.avgSpm)+"</div>"),T.push("<div class='lap-cell'>"+Math.round(L.avgSwolf)+"</div>"),t++}for(m=this.dataIndex,u=0;u<4;u++)d+=T[m],m=(m+1)%T.length;d+="</div>",null!=a.phases[t]&&null!=L&&L.phaseId!=a.phases[t].phaseId?(v=!0,this.phaseCounter++):null==a.phases[t]&&this.phaseCounter++}for(d+="</div>",this.lapDiv.html(d),this.pagingIndicator.html(h),
this.createLapSelectClickEvent(e),this.showRestOfLapData(e,o.length-1),this.createSwimmingPhasesContainerEvent(),t=0;t<this.phaseCounter;t++)this.collapseSwimmingPhaseContent(t);if(this.anchorHeaderToTop(),this.includeColumnBreakdownClassIntoTableControls(),this.loaded===!1)this.loaded=!0;else if(null!=i)for(t=0;t<i.length;t++){var f=i[t];if(!isNaN(f)){var S=this.lapDiv.find("div[phaseindex='"+f+"'][isgroupphase='group']");S.attr("phasestate","expanded");var w=S.find("a.btn");this.expandSwimmingPhasesContent(w,S)}}},Laps.prototype.renderPerformanceTestPhases=function(e){this.lapDiv.html("");var a="METRIC"===CommonHelpers.units,s=a?Messages["common.abbreviations.unitOfKilometersPerHour"]:Messages["common.abbreviations.unitOfMilesPerHour"],i="<div class='lap-table'>";i+="<div class='lap-row lap-th'>",i+="<div class='lap-cell static-cell static-header'>"+Messages["analyseview.lap.number_header"]+"</div>",i+="<div class='lap-cell static-cell static-header'>"+Messages["running_test.phase_column_heading"]+"</div>",i+="<div class='lap-cell static-cell static-header'>"+Messages["running_test.phase_duration_column_heading"]+"</div> ";var t=[],l=[];t.push("<div class='lap-cell'>"+Messages["analyseview.lap.avg_hr_header"]+"</div>"),l.push("<li></li>"),t.push("<div class='lap-cell'>"+Messages["analyseview.lap.max_hr_header"]+"</div>"),l.push("<li></li>"),t.push("<div class='lap-cell'>"+Messages["analyseview.lap.avg_speed_header"]+"</div>"),l.push("<li></li>"),t.push("<div class='lap-cell'>"+Messages["analyseview.lap.max_speed_header"]+"</div>"),l.push("<li></li>"),t.push("<div class='lap-cell'>"+Messages["bikepower.analysisview.lap.power.data_power_avg"]+"</div>"),l.push("<li></li>"),t.push("<div class='lap-cell'>"+Messages["bikepower.analysisview.lap.power.data_power_max"]+"</div>"),l.push("<li></li>"),t.push("<div class='lap-cell'>"+Messages["analyseview.lap.avg_cadence_header"]+"</div>"),l.push("<li></li>"),t.push("<div class='lap-cell'>"+Messages["analyseview.lap.max_cadence_header"]+"</div>"),l.push("<li></li>");for(var n=this.dataIndex,r=0;r<4;r++)i+=t[n],l[n]="<li class='visible-cell'></li>",n=(n+1)%t.length;i+="</div>";for(var p=Laps.lapType.perfTest,c=this.getLapText(p),d=0;d<e.length;d++){i+="<div type='"+p.name+"' lap_index='"+e[d].lapNumber+"' class='lap-row "+c+"RowDiv' id='"+c+"Div_"+e[d].lapNumber+"'>";var o=e[d].duration,h=e[d].statistics.heartRate.avg,m=e[d].statistics.heartRate.max,u=CommonHelpers.convertSpeedToImperialSpeed(e[d].statistics.speed.avg),v=CommonHelpers.convertSpeedToImperialSpeed(e[d].statistics.speed.max),g=ParameterManager.get("powerUnit").decimals,T=CommonHelpers.round(e[d].statistics.power.avg*ParameterManager.get("powerUnit").factor,g).toFixed(g),y=CommonHelpers.round(e[d].statistics.power.max*ParameterManager.get("powerUnit").factor,g).toFixed(g),L=e[d].statistics.cadence.avg,f=e[d].statistics.cadence.max;i+="<div class='lap-cell static-cell'>"+Number(e[d].lapNumber+1)+"</div>",i+="<div class='lap-cell static-cell'>"+this.getPerformanceTestPhaseName(e[d].phaseType)+"</div>",i+="<div class='lap-cell static-cell'>"+CommonHelpers.getSecondsAsDuration(o.standardSeconds)+"</div>";var S=[];S.push("<div class='lap-cell'>"+h+" "+Messages["common.abbreviations.unitOfHeartbeat"]+"</div>"),S.push("<div class='lap-cell'>"+m+" "+Messages["common.abbreviations.unitOfHeartbeat"]+"</div>"),S.push("<div class='lap-cell'>"+CommonHelpers.round(u,1)+" "+s+"</div>"),S.push("<div class='lap-cell'>"+CommonHelpers.round(v,1)+" "+s+"</div>"),S.push("<div class='lap-cell'>"+T+" "+ParameterManager.get("powerUnit").msg+"</div>"),S.push("<div class='lap-cell'>"+y+" "+ParameterManager.get("powerUnit").msg+"</div>"),S.push("<div class='lap-cell'>"+L+"</div>"),S.push("<div class='lap-cell'>"+f+"</div>"),n=this.dataIndex;for(var r=0;r<4;r++)i+=S[n],n=(n+1)%S.length;i+="</div>"}i+="</div>",this.lapDiv.html(i),this.pagingIndicator.html(l),this.createLapSelectClickEvent(p),this.showRestOfLapData(p,t.length-1),this.anchorHeaderToTop(),this.includeColumnBreakdownClassIntoTableControls()},Laps.prototype.getPerformanceTestPhaseName=function(e){return"WARMUP"===e?Messages["running_test.phase_warmup"]:"PERFORMANCE_TEST"===e?Messages["running_test.phase_test"]:"COOLDOWN"===e?Messages["running_test.phase_cooldown"]:""},Laps.prototype.setMode=function(e){GLOBAL_currentAnalyseMode=ANALYSEMODE.ANALYSE},Laps.prototype.buildLapEventObject=function(e,a,s,i,t){var l={selectedLapIndex:e,currentActiveLapsArray:a,selectionRange:s,customLapText:i,customLapTooltipText:t};return window.globalStrengthTrainingStash={lapEventObject:l},l},Laps.prototype.highlightLap=function(e,a){this.resetLapHighlight(),this.selectedLapIndex=a;var s=this,i=0;$("."+this.getLapText(e)+"RowDiv").each(function(e){s.type===Laps.lapType.swimming?"group"!=$(this).attr("isgroupphase")?$(this).attr("lap_index")==a&&$(this).addClass("highlight"):i++:e==a&&$(this).addClass("highlight")})},Laps.prototype.getLapData=function(e){return $.ajax({type:"GET",url:"/training/analysis/"+e+"/lap/data",dataType:"json",contentType:"application/json; charset=utf-8",success:function(e){this.currentExeInfos=e},error:function(e,a,s){CommonHelpers.log("error getting lap data")}})},Laps.prototype.displayTrainingPeaksDisclaimerIfNeeded=function(){$(".trainingpeaks-data-item-laps").length>0?$("#trainingpeaks_analysis_disclaimer_text").show():0!==$(".trainingpeaks-data-item-laps").length||$(".trainingpeaks-data-item-basic").closest(".training-edit-container").hasClass("is-visible")||$("#trainingpeaks_analysis_disclaimer_text").hide()},Laps.prototype.getLaps=function(e,a,s,i){var t,l=this,n=this.getCurrentExerciseInfo();switch(e){case Laps.lapType.manual:case Laps.lapType.auto:t={exeId:a,type:e.name};break;case Laps.lapType.generated:t={exeId:a,type:e.name,split:s};break;case Laps.lapType.swimming:return this.loaded=!1,this.calculateActiveLapsArray(this.phases[a].phases,a),this.renderSwimmingPhases(l.type,this.phases[a],!0),void this.sendSelectLapTypeEvent(l.currentExeInfos,l.currentActiveLapsArray,e);case Laps.lapType.phases:return this.phasesShown=!0,this.calculateActiveLapsArray(exerciseTargetResults[a].exercisePhasedTargetData,a),this.renderPhases(),void this.sendSelectLapTypeEvent(l.currentExeInfos,l.currentActiveLapsArray,e);case Laps.lapType.hills:return this.hills=store.getHillDataForExercise(a),this.currentLapsData=l.buildHillLapsArray(s),this.calculateActiveLapsArray(this.currentLapsData,a,n),l.currentActiveLapsArray=l.currentActiveLapsArray.filter(function(e){return!s||e.hillPhase===s.toUpperCase()||"AllHills"===s}),l.currentActiveLapsArray.forEach(function(e,a){e.lapNumber=a}),l.currentLapsData=l.currentLapsData.filter(function(e){return!s||e.hillPhase===s.toUpperCase()||"AllHills"===s}),l.currentLapsData.forEach(function(e,a){e.lapNumber=a}),this.renderLaps(Laps.lapType.hills,l.currentLapsData,!1),void this.sendSelectLapTypeEvent(l.currentExeInfos,l.currentActiveLapsArray,e);case Laps.lapType.perfTest:return this.currentLapsData=l.buildPerformanceTestLapsArray(this.performanceTestData),this.renderPerformanceTestPhases(this.currentLapsData),void this.sendSelectLapTypeEvent(l.currentExeInfos,this.currentLapsData,e);default:return}$.ajax({type:"POST",url:"/training/getLaps",data:JSON.stringify(t),dataType:"json",contentType:"application/json; charset=utf-8",success:function(s){l.currentLapsData=s,l.calculateActiveLapsArray(s,a,n),l.renderLaps(e,s,n.isTypeSpeed),l.displayTrainingPeaksDisclaimerIfNeeded(),l.sendSelectLapTypeEvent(l.currentExeInfos,l.currentActiveLapsArray,e),void 0!==i&&null!==i&&i<=s.length&&(l.setMode(ANALYSEMODE.ANALYSE),l.SelectLap(l.type,i,!1))}})},Laps.prototype.calculateActiveLapsArray=function(e,a){var s=this.getCurrentExerciseInfo(),i=new Array,t=0,l=this.selectedData.startTime,n=this.selectedData.stopTime;for(var r in e){var p=e[r],c=new Object;p.hillPhase&&(c.hillPhase=p.hillPhase),c.exerciseStartTime=l,c.exerciseStopTime=n,c.startTime=l+p.startSplitTime.millis,c.stopTime=c.startTime+p.duration.millis,c.startDistance=t,c.stopDistance=t+p.distance,c.lapNumber=p.lapNumber,c.isNewLap=!1,c.lapSplitTimeMod=p.startSplitTime.millis%1e3,c.isSwimmingExercise=s.isSwimmingExercise,null!=p.swimmingPacePerDistance&&p.swimmingPacePerDistance>0?c.pace=p.swimmingPacePerDistance:null!=p.speed&&(c.pace=CommonHelpers.convertSpeedToSwimmingPace(p.speed.avg,"IMPERIAL")),t+=p.distance,i.push(c)}this.currentActiveLapsArray=i},Laps.prototype.getLapText=function(e){return e===Laps.lapType.swimming?"Phases":e===Laps.lapType.perfTest?Laps.lapType.perfTest.name:"Man"},Laps.prototype.resetLapHighlight=function(){this.selectedLapIndex=null,$("."+this.getLapText(this.type)+"RowDiv").each(function(){$(this).removeClass("highlight")})},Laps.prototype.createLapSelectClickEvent=function(e){var a=this,s=this.getLapText(e);$("."+s+"RowDiv").unbind("click").bind("click",function(s){if(!$(s.target).hasClass("icon icon-arrow-right")){var i=$(this).attr("lap_index"),t=parseInt($(this).data("swimming-phase-index"));e===Laps.lapType.perfTest?a.SelectPerformanceTestPhase(i):a.SelectLap(e,i,"group"===$(this).attr("isgroupphase"),t)}})},Laps.prototype.SelectLap=function(e,a,s,i){var t=this;if(t.hasSamplesVisible!==!1&&GLOBAL_currentAnalyseMode===ANALYSEMODE.ANALYSE)if(void 0!=a||null==i)if(a===t.selectedLapIndex||s)t.selectedLapIndex=null,t.resetLapHighlight(),$.dispatcher.trigger("laps.unselectLap");else{t.selectedLapIndex=a,t.highlightLap(e,a);var l=null;if(t.currentActiveLapsArray&&t.currentActiveLapsArray.length>0&&(l=t.currentActiveLapsArray[a]),null!=l){var n,r=Messages["analyseview.lap.laptext"]+" {0}".format(Number(t.selectedLapIndex)+1);n=store.getIsDurationBased()?new SelectionRange(!0,l.startTime,l.stopTime):l.startDistance==l.stopDistance?new SelectionRange(!1,l.startDistance,l.stopDistance):new SelectionRange(!0,l.startTime,l.stopTime),null!=t.phases&&null!=t.phases[t.currentExerciseId]&&null!=t.phases[t.currentExerciseId].phases[t.selectedLapIndex]&&$("#swimmingTab").parent().hasClass("active")===!0&&(r=t.phases[t.currentExerciseId].phases[t.selectedLapIndex].style),t.phasesShown&&(r=Messages["trainingTarget.phase.noun"]+" "+(Number(t.selectedLapIndex)+1)+": "+exerciseTargetResults[t.currentExerciseId].exercisePhasedTargetData[t.selectedLapIndex].name);var p={selectedLapIndex:t.selectedLapIndex,currentActiveLapsArray:t.currentActiveLapsArray,selectionRange:n,customLapText:r,type:e};$.dispatcher.trigger("laps.selectLap",p)}}else{t.selectedLapIndex=Number.MAX_VALUE;var c=this.lapDiv.find("div[data-swimming-phase-index='"+i+"'][isgroupphase='group']"),d=c.attr("phasestate");if("expanded"===d&&c.hasClass("highlight")){c.attr("phasestate","collapsed"),c.removeClass("swimming-phase__expanded");var o=c.find("a.btn");o.css("transform","rotate(0deg)"),this.collapseSwimmingPhaseContent(c.attr("phaseindex")),t.selectedLapIndex=null,t.resetLapHighlight(),$.dispatcher.trigger("laps.unselectLap")}else{$(".lap-row").removeClass("highlight"),c.attr("phasestate","expanded"),c.addClass("swimming-phase__expanded"),c.addClass("highlight");var o=c.find("a.btn");this.expandSwimmingPhasesContent(o,c);var p={swimmingPhaseIndex:i};$.dispatcher.trigger("laps.selectSwimmingPhase",p)}}},Laps.prototype.SelectPerformanceTestPhase=function(e){if(e===this.selectedLapIndex)this.selectedLapIndex=null,this.resetLapHighlight(),$.dispatcher.trigger("laps.unselectLap");else{this.selectedLapIndex=e,this.highlightLap(Laps.lapType.perfTest,e);var a=this.currentLapsData[e],s=new SelectionRange(!0,a.startTime,a.stopTime),i=Messages["running_test.phase_column_heading"]+" {0}".format(Number(e)+1),t={selectedLapIndex:e,currentActiveLapsArray:this.currentLapsData,selectionRange:s,customLapText:i,type:Laps.lapType.perfTest};$.dispatcher.trigger("laps.selectLap",t)}},Laps.prototype.showRestOfLapData=function(e,a){var s=this,i=this.getCurrentExerciseInfo();$("#analysisLeftLapData").unbind("click").bind("click",function(){if(s.currentLapsData.length>0||$("#phasesTab").parent().hasClass("active")||$("#swimmingTab").parent().hasClass("active")||$("#perfTestTab").parent().hasClass("active")){var t=s.searchExpandedPhaseGroups();0==s.dataIndex?s.dataIndex=a:s.dataIndex--,$("#swimmingTab").parent().hasClass("active")===!0?s.renderSwimmingPhases(Laps.lapType.swimming,s.phases[s.currentExerciseId],!0,t):$("#phasesTab").parent().hasClass("active")===!0?s.renderPhases():$("#perfTestTab").parent().hasClass("active")===!0?s.renderPerformanceTestPhases(s.currentLapsData):s.renderLaps("",s.currentLapsData,i.isTypeSpeed),null!=s.selectedLapIndex&&s.highlightLap(e,s.selectedLapIndex),s.displayTrainingPeaksDisclaimerIfNeeded()}}),$("#analysisRightLapData").unbind("click").bind("click",function(){if(s.currentLapsData.length>0||$("#phasesTab").parent().hasClass("active")||$("#swimmingTab").parent().hasClass("active")||$("#perfTestTab").parent().hasClass("active")){var t=s.searchExpandedPhaseGroups();s.dataIndex==a?s.dataIndex=0:s.dataIndex++,$("#swimmingTab").parent().hasClass("active")===!0?s.renderSwimmingPhases(Laps.lapType.swimming,s.phases[s.currentExerciseId],!0,t):$("#phasesTab").parent().hasClass("active")===!0?s.renderPhases():$("#perfTestTab").parent().hasClass("active")===!0?s.renderPerformanceTestPhases(s.currentLapsData):s.renderLaps("",s.currentLapsData,i.isTypeSpeed),null!=s.selectedLapIndex&&s.highlightLap(e,s.selectedLapIndex),s.displayTrainingPeaksDisclaimerIfNeeded()}})},Laps.prototype.searchExpandedPhaseGroups=function(){var e=this.lapDiv.find("div[phasestate='expanded']");if(e.length){for(var a=new Array,s=0;s<e.length;s++){var i=$(e[s]);null!=i&&a.push(parseInt(i.attr("phaseindex")))}return a}return[]},Laps.prototype.selectLapTypeClickEvent=function(e,a,s){this.clearLaps(),this.type=e,this.getLaps(e,a,s),this.resetLapHighlight(e),this.setMode(ANALYSEMODE.ANALYSE)},Laps.prototype.createClickEvents=function(){function e(){$("#hillLapList").hide(),$("#lapGenerationList").hide()}var a=this,s="off",i=$("#lapGenerationList");$(".laps-collapse").on("click",function(a){a.preventDefault(),e();var s=$(this).attr("ref");$("#"+s).is(":hidden")?($("#"+s).show(),$(this).parent().addClass("active")):($("#"+s).hide(),$(this).parent().removeClass("active"))}),$("#generatedlapsTab").bind("click",function(i){e(),$(this).parent().hasClass("active")||("off"===s?(e(),$(".laps-collapse").click()):(a.type=Laps.lapType.generated,a.getLaps(a.type,a.currentExerciseId,s),a.resetLapHighlight()),$("#lapTypeSelectionHeaderBlock").removeClass("hills"))}),$(".generateAutolaps").bind("click",function(t){t.preventDefault();var l=$(this).parents(".dropdown");e();return s=$(this).attr("split"),"off"===s?(a.clearLaps(),a.type=Laps.lapType.generated,a.renderLaps(a.type,[],!0),l.removeClass("active").siblings().removeClass("active"),a.sendSelectLapTypeEvent(a.currentExeInfos,[],a.type)):(l.siblings().removeClass("active"),$("#generatedlapsTab").parent().toggleClass("active"),a.selectLapTypeClickEvent(Laps.lapType.generated,a.currentExerciseId,s)),i.hide(),$("#lapTypeSelectionHeaderBlock").removeClass("hills"),!1}),$("#lapsTab").bind("click",function(s){e(),$(this).parent().hasClass("active")?(a.clearLaps(),a.resetLapHighlight()):(s.preventDefault(),a.selectLapTypeClickEvent(Laps.lapType.manual,a.currentExerciseId,0),$("#lapTypeSelectionHeaderBlock").removeClass("hills"))}),$("#autoLapsTab").bind("click",function(s){e(),$(this).parent().hasClass("active")||(s.preventDefault(),a.selectLapTypeClickEvent(Laps.lapType.auto,a.currentExerciseId,0),$("#lapTypeSelectionHeaderBlock").removeClass("hills"))}),$("#swimmingTab").bind("click",function(s){e(),$(this).parent().hasClass("active")||(s.preventDefault(),a.selectLapTypeClickEvent(Laps.lapType.swimming,a.currentExerciseId,0),$("#lapTypeSelectionHeaderBlock").removeClass("hills"),a.swimmingShown=!0)}),$("#phasesTab").bind("click",function(s){e(),$(this).parent().hasClass("active")||(s.preventDefault(),a.selectLapTypeClickEvent(Laps.lapType.phases,a.currentExerciseId,0),a.phasesShown=!0,$("#lapTypeSelectionHeaderBlock").removeClass("hills"))}),$("#hillTab").bind("click",function(i){e();var t=$("#hillLapList");0===$("#lapTabsHeader .active").length?(i.preventDefault(),s="AllHills",a.selectLapTypeClickEvent(Laps.lapType.hills,a.currentExerciseId,s),$("#hillTab").addClass("active"),$("#lapTypeSelectionHeaderBlock").addClass("hills")):a.resetLapHighlight(),t.is(":hidden")&&"AllHills"!==s?(t.show(),t.parent().addClass("active")):(t.hide(),"AllHills"!==s&&t.parent().removeClass("active"),s="off")}),$(".hillSplit").bind("click",function(s){var i=$(this).parents(".dropdown");s.preventDefault();var t=$(this).attr("split");a.type=Laps.lapType.hills,i.siblings().removeClass("active"),$("#hillTab").parent().toggleClass("active");var l='<i class="icon icon-arrow-down"></i>';switch(t){case"UpHill":$("#hillListHandle").text(Messages["hill_splitter.training_analysis_view.toggle.uphills"]+" ").append(l);break;case"DownHill":$("#hillListHandle").text(Messages["hill_splitter.training_analysis_view.toggle.downhills"]+" ").append(l);break;case"AllHills":default:$("#hillListHandle").text(Messages["hill_splitter.training_analysis_view.toggle.uphills_and_downhills"]+" ").append(l)}return a.selectLapTypeClickEvent(Laps.lapType.hills,a.currentExerciseId,t),e(),$("#lapTypeSelectionHeaderBlock").addClass("hills"),!1}),$("#perfTestTab").bind("click",function(e){$(this).parent().hasClass("active")||(e.preventDefault(),a.selectLapTypeClickEvent(Laps.lapType.perfTest,a.currentExerciseId,0),$("#lapTypeSelectionHeaderBlock").removeClass("hills"))})},Laps.prototype.buildHillLapsArray=function(){function e(e,t){var h={},m=null,u=null,v=null,g=null,T=null,y=null;if(d&&d.distanceSamples){var L=d.distanceSamples.find(function(a){return a[0]===e}),f=d.distanceSamples.find(function(e){return e[0]+1e3>t||e[0]===d.distanceSamples[d.distanceSamples.length-1][0]});T=L[1],y=f[1]}if(o&&o[0]&&o[0].durationBasedSamples){o[0].durationBasedSamples.SPEED&&(m=a(o[0].durationBasedSamples.SPEED[0],e,t)),o[0].durationBasedSamples.HEART_RATE&&(u=a(o[0].durationBasedSamples.HEART_RATE[0],e,t)),o[0].durationBasedSamples.CADENCE&&(v=a(o[0].durationBasedSamples.CADENCE[0],e,t)),o[0].durationBasedSamples.POWER&&(g=a(o[0].durationBasedSamples.POWER[0],e,t))}h.exerciseStartTime=n,h.exerciseStopTime=r,h.startTime=e,h.stopTime=t,h.hillPhase="FLAT",h.isNewLap=!1,h.duration=getStandardTimeValuesFromMillis(t-e),h.startSplitTime=getStandardTimeValuesFromMillis(e-n),h.splitTime=getStandardTimeValuesFromMillis(h.duration.millis+h.startSplitTime.millis),h.startDistance=T,h.stopDistance=y,h.distance=h.stopDistance-h.startDistance,h.lapNumber=c,h.speed={avg:i(m),max:s(m)},h.heartRate={avg:Math.round(i(u)),max:s(u)},h.cadence={avg:Math.round(i(v)),max:s(v)},h.power={avg:Math.round(i(g)),max:s(g)},l+=h.distance,p.push(h),c++}function a(e,a,s){return e.filter(function(e){return a<=e[0]&&s>=e[0]}).map(function(e){return e[1]})}function s(e){return e?e.reduce(function(e,a){return Math.max(e,a)}):NaN}function i(e){return e?e.reduce(function(e,a){return e+a})/e.length:NaN}var t=this,l=0,n=t.selectedData.startTime,r=t.selectedData.stopTime,p=[],c=0,d=store.getCurveData(),o=null;d&&d.exercises&&(o=d.exercises.filter(function(e){return e.id===Number(t.currentExerciseId)}));for(var h=t.hills,m=0;m<h.length;m++){var u=h[m];0===m&&n+1e3<u.startTime.localDateTime&&e(n,u.startTime.localDateTime),m<h.length&&m>0&&h[m-1].endTime.localDateTime+1e3<u.startTime.localDateTime&&e(h[m-1].endTime.localDateTime,u.startTime.localDateTime),function(e){var a={};a.exerciseStartTime=n,a.exerciseStopTime=r,a.startTime=e.startTime.localDateTime,a.stopTime=e.endTime.localDateTime,a.hillPhase=e.type,a.duration=getStandardTimeValuesFromMillis(e.data.DURATION.numValue),a.startSplitTime=getStandardTimeValuesFromMillis(a.startTime-n),a.splitTime=getStandardTimeValuesFromMillis(a.duration.millis+a.startSplitTime.millis),a.distance=e.data.DISTANCE.numValue,a.startDistance=l,l+=e.data.DISTANCE.numValue,a.stopDistance=l,a.lapNumber=c,a.isNewLap=!1,a.speed={max:e.data.MAX_SPEED.numValue,avg:e.data.AVG_SPEED.numValue},a.heartRate={avg:e.data.AVG_HEART_RATE.numValue,max:e.data.MAX_HEART_RATE.numValue},a.cadence={avg:e.data.AVG_CADENCE.numValue,max:e.data.MAX_CADENCE.numValue},a.power={avg:e.data.AVG_POWER.numValue,max:e.data.MAX_POWER.numValue},"UPHILL"===e.type?(a.angleAvg=e.data.AVG_INCLINE.numValue,a.hillNumber=e.data.UPHILL_NUMBER.numValue,a.ascentDescent=e.data.ASCENT.numValue):(a.angleAvg=e.data.AVG_DECLINE.numValue,a.hillNumber=e.data.DOWNHILL_NUMBER.numValue,a.ascentDescent=e.data.DESCENT.numValue),p.push(a),c++}(u)}return h[h.length-1].endTime.localDateTime+1e3<r&&e(h[h.length-1].endTime.localDateTime,r),p},Laps.prototype.buildPerformanceTestLapsArray=function(e){var a=this.selectedData.startTime,s=this.selectedData.stopTime,i=[],t=0;if(e)for(var l=0;l<e[0].subperiods.length;l++){var n={},r=e[0].subperiods[l];n.exerciseStartTime=a,n.exerciseStopTime=s;var p=r.startTime.localDateTime,c=r.endTime.localDateTime;n.phaseType=r.type,n.duration=getStandardTimeValuesFromMillis(c-p),n.startTime=p,n.stopTime=c,n.lapNumber=t,n.statistics={},n.statistics.speed={max:r.data.MAX_SPEED.numValue,avg:r.data.AVG_SPEED.numValue},n.statistics.heartRate={avg:r.data.AVG_HEART_RATE.numValue,max:r.data.MAX_HEART_RATE.numValue},n.statistics.cadence={avg:r.data.AVG_CADENCE.numValue,max:r.data.MAX_CADENCE.numValue},n.statistics.power={avg:r.data.AVG_POWER.numValue,max:r.data.MAX_POWER.numValue},i.push(n),t++}return i},getStandardTimeValuesFromMillis=function(e){e||0===e||(e=void 0);var a=Math.floor(e/1e3);return new Object({standardSeconds:Math.floor(a),standardMinutes:Math.floor(a/60),standardHours:Math.floor(a/60/60),standardDays:Math.floor(a/60/60/24),millis:1e3*a})},Laps.prototype.saveLapDataAndRenderPage=function(){for(var e=this,a=[],s={},i=0;i<e.currentActiveLapsArray.length;i++){var t={},s=e.currentActiveLapsArray[i];t.splitTime=s.stopTime-s.exerciseStartTime,t.duration=s.stopTime-s.startTime,t.lapNumber=s.lapNumber,a.push(t)}$.ajax({type:"POST",url:jsRoutes.controllers.training.analysis.TrainingSessionTask.updateExerciseLaps(e.currentExerciseId).url,data:JSON.stringify(a),dataType:"json",contentType:"application/json; charset=utf-8",success:function(e){CommonHelpers.log(" TODO: Notify user somehow")},error:function(e,a,s){CommonHelpers.log(" TODO: Notify user somehow")},complete:function(){e.reloadLapDataAndRenderViews()}})},Laps.prototype.reloadLapDataAndRenderViews=function(){var e=this;$.when(e.getLapData(store.getTrainingSession().id)).then(function(a){if(e.currentExeInfos=a,e.getCurrentExerciseInfo()){var s=e.selectedLapIndex;e.hasLapsAndPhases=e.doesExerciseHaveLapsAndPhases(e.currentExeInfos.lapExercises),e.getLaps(e.type,e.currentExerciseId,0,s)}else CommonHelpers.log("Cannot get exercise lap data. Nothing to render")})},Laps.prototype.sendSelectLapTypeEvent=function(e,a,s){$.dispatcher.trigger("laps.selectLapType",{lapData:e,lapDataValues:a,hasLapsAndPhases:this.hasLapsAndPhases,phasesShown:this.phasesShown,type:s})},Laps.prototype.getCurrentExerciseInfo=function(){var e=this.currentExeInfos.lapExercises;for(var a in e){var s=e[a];if(s.exerciseId==this.currentExerciseId)return s}return null},Laps.prototype.collapseSwimmingPhaseContent=function(e){for(var a=this.lapDiv.find("div[type='"+Laps.lapType.swimming.name+"'][phaseindex = '"+e+"']"),s=0;s<a.length;s++)0==s?($(a[s]).attr("phasestate","collapsed"),$(a[s]).removeClass("swimming-phase__expanded")):$(a[s]).css("display","none")},Laps.prototype.createSwimmingPhasesContainerEvent=function(){var e=this;this.lapDiv.find("div[type='"+Laps.lapType.swimming.name+"']").find("a.btn").bind("click",function(){var a=$(this).parentsUntil("div[type='"+Laps.lapType.swimming.name+"']").parent()[0],s=$(a);"collapsed"==s.attr("phasestate")?e.expandSwimmingPhasesContent(this,s):($(this).css("transform","rotate(0deg)"),e.collapseSwimmingPhaseContent(parseInt(s.attr("phaseindex"))))})},Laps.prototype.expandSwimmingPhasesContent=function(e,a){$(e).css("transform","rotate(90deg)"),a.addClass("swimming-phase__expanded"),a.attr("phasestate","expanded");for(var s=parseInt(a.attr("phaseindex")),i=this.lapDiv.find("div[type='"+Laps.lapType.swimming.name+"'][phaseindex = '"+s+"']"),t=0;t<i.length;t++)$(i[t]).css("display","flex")},Laps.prototype.buildPhasesSummary=function(){for(var e in this.phases){var a=this.phases[e],s="";if(a.summaries=[],null!=a&&null!=a.phases&&a.phases.length){s=a.phases[0].style;for(var i=0,t=0,l=99999,n=0,r=0,p=0,c=0,d=0,o=0,h=0,m=!1,u=!1,v=0,g=0,T=null,y=0;y<a.phases.length;y++){var L=a.phases[y];0==v&&(m=this.checkForMedleySummary(a,y),u=this.checkForMixedSummary(a,y,0,{BUTTERFLY:0,FREESTYLE:0,BACKSTROKE:0,BREASTSTROKE:0}),v=m===!0?4:u===!0?3:0,s=m===!0?Messages["diary.result.swimming_indoor.individual_medley"]:u===!0?Messages["diary.result.swimming_indoor.mixed"]:s,g=m===!0||u===!0?L.phaseId:g),1==v&&(m=!1,u=!1,v=0,L.phaseId=g),s.toUpperCase()==L.style.toUpperCase()||0!=v&&1!=m&&u!==!0?(i+=L.distance,t=this.addDuration(t,L.duration),n++,r+=L.avgPace,p+=L.avgHeartRate,d+=L.avgStroke,o+=L.avgSwolf,h+=L.avgSpm,L.maxPace<l&&(l=L.maxPace),L.maxHeartRate>c&&(c=L.maxHeartRate),v>0&&(v--,L.phaseId=g)):(T=this.calculateSummaryValues(a,r,p,d,o,h,i,t,l,c,n,y,m,u,s),a.summaries.push(T),0==v&&(s=L.style),t=0,i=0,n=0,r=0,l=0,p=0,c=0,d=0,o=0,h=0,0==v&&(g=0),m=!1,u=!1,y--)}null==T&&(T=this.calculateSummaryValues(a,r,p,d,o,h,i,t,l,c,n,y,m,u,s)),T=n>1?this.calculateSummaryValues(a,r,p,d,o,h,i,t,l,c,n,y,m,u,s):{style:L.style,distance:L.distance,duration:L.duration,avgPace:L.avgPace,maxPace:L.maxPace,avgHeartRate:L.avgHeartRate,maxHeartRate:L.maxHeartRate,avgStroke:L.avgStroke,avgSpm:L.avgSpm,avgSwolf:L.avgSwolf},a.summaries.push(T)}}},Laps.prototype.calculateSummaryValues=function(e,a,s,i,t,l,n,r,p,c,d,o,h,m,u){var v=0===o?e.phases[0]:e.phases[o-1],g=0==d?v.avgPace:a/d,T=0==d?v.avgHeartRate:s/d,y=0==d?v.avgStroke:i/d,L=0==d?v.avgSwolf:t/d,f=0==d?v.avgSpm:l/d;0==d&&(n=v.distance,r={millis:v.duration.millis,standardDays:v.duration.standardDays,standardMinutes:v.duration.standardMinutes,standardHours:v.duration.standardHours,standardSeconds:v.duration.standardSeconds},p=v.maxPace,c=v.maxHeartRate);var S=u;return h===!0&&null!=e.phases[o-1]&&(S=e.phases[o-1].style),{style:S,distance:n,duration:r,avgPace:g,maxPace:p,avgHeartRate:T,maxHeartRate:c,avgStroke:y,avgSpm:f,avgSwolf:L}},Laps.prototype.checkForMedleySummary=function(e,a){return null!=e&&null!=e.phases&&null!=e.phases[a]&&"BUTTERFLY"==e.phases[a].style.toUpperCase()&&null!=e.phases[a+1]&&"BACKSTROKE"==e.phases[a+1].style.toUpperCase()&&null!=e.phases[a+2]&&"BREASTSTROKE"==e.phases[a+2].style.toUpperCase()&&null!=e.phases[a+3]&&"FREESTYLE"==e.phases[a+3].style.toUpperCase()},Laps.prototype.checkForMixedSummary=function(e,a,s,i){if(null==e||null==e.phases)return!1;if(3==s){if(null==i||$.isEmptyObject(i))return!1;for(var t in i){var l=i[t];if(0==l||l>1)return!1}return!0}if(null==e.phases[a])return!1;var n=e.phases[a].style.toUpperCase();i[n]=i[n]+1,this.checkForMixedSummary(e,a+1,s+1,i)},Laps.prototype.buildPhasesData=function(){null!=this.phases&&this.buildPhasesSummary()},Laps.prototype.addDuration=function(e,a){return"object"==typeof e?"object"==typeof a?(e.millis+=a.millis,e.standardDays+=a.standardDays,e.standardMinutes+=a.standardMinutes,e.standardHours+=a.standardHours,e.standardSeconds+=a.standardSeconds,e):e:{millis:a.millis,standardDays:a.standardDays,standardMinutes:a.standardMinutes,standardHours:a.standardHours,standardSeconds:a.standardSeconds}},Laps.prototype.updateDurationRangeSelector=function(e){if(!e.isDurationBased)return"No lap modification with distances implemented";var a="",s=this.currentActiveLapsArray[this.selectedLapIndex],i=e.start-s.startTime,t=e.stop-s.stopTime,l=GLOBAL_currentAnalyseMode===ANALYSEMODE.ADDLAP?1:0,n=this.moveActiveLapTimes(l,this.currentActiveLapsArray,this.selectedLapIndex,i,t);this.selectedLapIndex=n.newSelectedLapIndex,this.currentActiveLapsArray=n.newLapArray,store.getTrainingSession().distanceSamples&&(this.currentActiveLapsArray=this.updateDistances(this.currentActiveLapsArray,store.getTrainingSession().distanceSamples)),s=this.currentActiveLapsArray[this.selectedLapIndex];var r=new SelectionRange(!0,s.startTime,s.stopTime);a=GLOBAL_currentAnalyseMode===ANALYSEMODE.ADDLAP?Messages["add.edit.laps.add.lap.add_new_lap_marker"]:Messages["add.edit.laps.edit_lap_marker"].format(Number(this.selectedLapIndex)+1);var p=this.buildLapEventObject(this.selectedLapIndex,this.currentActiveLapsArray,r,a,null);$.dispatcher.trigger(GLOBAL_currentAnalyseMode===ANALYSEMODE.ADDLAP?"laps.addLap":"laps.editLap",p)},Laps.prototype.updateDistances=function(e,a){for(var s=e,i=0;i<s.length;i++){var t=s[i];t.startDistance=helpers.findDistanceByTime(t.startTime,a);var l=helpers.findDistanceByTime(t.stopTime,a);null!==l&&(t.stopDistance=l),s[i]=t}return s},Laps.prototype.includeColumnBreakdownClassIntoTableControls=function(){var e=this.lapDiv.find(".lap-th .static-header").length,a=this.lapDiv.find(".lap-th .lap-cell").length,s=$("#LapsTable").find(".lap-main-header-block");s.removeClass("ext-idx-col").removeClass(function(e,a){return(a.match(/(^|\s)static-cells-\S+/g)||[]).join(" ")}).removeClass(function(e,a){return(a.match(/(^|\s)overall-cells-\S+/g)||[]).join(" ")}).addClass("static-cells-"+(e-1)).addClass("overall-cells-"+(a-1)),this.type===Laps.lapType.swimming&&s.addClass("ext-idx-col")},Laps.prototype.anchorHeaderToTop=function(){var e=this.lapDiv.find(".lap-th");this.lapDiv.find(".lap-row:not(.lap-th)").first().css("margin-top",e.height()+"px"),this.lapDiv.parent().off("scroll"),this.lapDiv.parent().scroll(function(a){e.css("top",a.currentTarget.scrollTop+"px")}),e.css("top",this.lapDiv.parent().scrollTop()+"px")},Laps.prototype.moveActiveLapTimes=function(e,a,s,i,t){for(var l=a.slice(),n=s,r=!1,p=s;p<l.length;p++){var c=p>0?l[p-1]:null,d=l[p],o=p<l.length-1?l[p+1]:null;if(r=!1,0===p&&0===s&&(i<0||i>0)||0===p&&0===s&&d.stopTime-d.startTime<=1e3||p===l.length-1&&s===l.length-1&&(t>0||t<0)||p===l.length-1&&s===l.length-1&&d.stopTime-d.startTime<=1e3||p===s&&0===e&&t<0&&d.stopTime+t<=d.startTime+1e3||p===s&&0===e&&t>0&&null!==o&&d.stopTime+t>=o.stopTime-1e3||p===s&&p===l.length-2&&t>0&&null!==o&&d.stopTime+t>=o.stopTime-1e3)break;if(p===s)if(t<0&&null!==c&&d.stopTime+t<=d.startTime+1e3)n--,d.isNewLap=!1,d.stopTime+t<=c.stopTime+1e3&&d.stopTime+t>=c.stopTime-1e3?d.startTime=c.stopTime-1e3:d.startTime=c.stopTime+t,d.stopTime=c.stopTime,c.stopTime=d.startTime,c.isNewLap=!0,l[p-1]=c,o&&(o.startTime=d.stopTime,l[p+1]=o,r=!0);else if(t>0&&null!==o&&d.stopTime+t>=o.stopTime-1e3){n++,d.isNewLap=!1;var h=d.stopTime;d.stopTime=o.stopTime,o.startTime=d.stopTime,o.isNewLap=!0,h+t<=o.stopTime+1e3&&h+t>=o.stopTime-1e3?o.stopTime=o.startTime+1e3:o.stopTime=o.startTime+t,l[p+1]=o,l[p+2]&&(l[p+2].startTime=o.stopTime),r=!0}else d.startTime+=i,d.stopTime+=t;else s-1>=0&&p===s-1?d.stopTime+=i:s+1<l.length&&p===s+1&&(d.startTime+=t);l[p]=d,r&&p++}return{newSelectedLapIndex:n,newLapArray:l}};
//# sourceMappingURL=laps.min.js.map