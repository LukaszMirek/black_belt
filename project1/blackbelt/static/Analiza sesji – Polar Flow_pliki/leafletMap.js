!function(){LMap=function(e,t,s){this.elementId=e,this.mapboxAccessToken=t,this.map=null,this.baseLayers=null,this.baseLayer=null,this.gl=null,this.model=null,this.$wrapper=null,this.$zoomIn=null,this.$zoomOut=null,this.$showMarkers=null,this.highlightTypes=null,this.highlightedRoute=null,this.selectedExercise=null,this.selectedRange=null,this.position=-1,this.positionMarker=null,this.racePacePositionMarker=null,this.markers=Markers.none,this.showMarkers=!0},LMap.prototype.init=function(e){if(void 0!==e.samples&&e.samples.length>0){this.$wrapper=$(".map-wrap"),this.$zoomIn=$("#mapZoomIn"),this.$zoomOut=$("#mapZoomOut"),this.$showMarkers=$("#showMarkers"),this.$wrapper.children().removeClass("hidden"),this.highlightTypes=LMapHelpers.getHighlightTypes(),this.highlightType=this.highlightTypes.none,this.map=L.map(this.elementId,{center:LMapConstants.DEFAULT_LOCATION,zoom:LMapConstants.DEFAULT_ZOOM,zoomControl:!1,scrollWheelZoom:!1,dragging:!AppGlobal.isMobile,attributionControl:!1,minZoom:LMapConstants.MIN_ZOOM,maxZoom:LMapConstants.MAX_ZOOM});var t=L.control({position:"topleft"});t.onAdd=function(e){var t=L.DomUtil.create("div","mapbox-logo");return t.innerHTML="<a href='http://mapbox.com/about/maps' class='mapbox-wordmark' target='_blank' >Mapbox</a>",t},t.addTo(this.map);var s="METRIC"===CommonHelpers.units;L.control.scale({metric:s,imperial:!s}).addTo(this.map),L.control.attribution({prefix:""}).addTo(this.map),this.icons=LMapHelpers.getIcons(),this.baseLayers=LMapHelpers.getBaseLayers(this.mapboxAccessToken),this.setBaseLayer(this.baseLayers.terrain),this.bindEvents(),this.model=e,SampleKeys=e.SampleKeys,ExerciseKeys=e.ExerciseKeys;var i=Object.keys(e.exercises);i.length>1?this.setHighlightType(this.highlightTypes.basic):(this.selectExercise(parseInt(i[0])),void 0!==exerciseID&&"STEADY_RACE_PACE"===e.exercises[exerciseID][ExerciseKeys.EXERCISE_TARGET_TYPE]?this.setHighlightType(this.highlightTypes.racepace):this.setHighlightType(this.highlightTypes.basic));var a=LMapHelpers.convertToLatLngPoints(e.samples);a.length>0&&(this.highlightedRoute=new LPolyline(this,this.highlightType.color,1,a))}},LMap.prototype.fitBounds=function(){this.map.fitBounds(this.highlightedRoute.getBounds(),{padding:[LMapConstants.FIT_BOUNDS_PADDING,LMapConstants.FIT_BOUNDS_PADDING]})},LMap.prototype.setBaseLayer=function(e){this.baseLayer&&this.map.removeLayer(this.baseLayer),this.gl=e.addTo(this.map),this.baseLayer=e},LMap.prototype.zoomIn=function(){this.map.setZoom(this.map.getZoom()+1)},LMap.prototype.zoomOut=function(){this.map.setZoom(this.map.getZoom()-1)},LMap.prototype.bindEvents=function(){var e=this;this.$zoomIn.click(function(t){return t.preventDefault(),e.zoomIn(),!1}),this.$zoomOut.click(function(t){return t.preventDefault(),e.zoomOut(),!1}),$("#showRoadMap").click(function(t){e.setBaseLayer(e.baseLayers.street),e.gl._update()}),$("#showSatelliteMap").click(function(t){e.setBaseLayer(e.baseLayers.satellite),e.gl._update()}),$("#showTerrainMap").click(function(t){e.setBaseLayer(e.baseLayers.terrain),e.gl._update()}),$("#fullScreenMap").click(function(t){e.openFullscreenMap()}),$("#resetFullScreenMap").click(function(t){e.closeFullscreenMap()}),this.$showMarkers.click(function(t){e.setShowMarkers($(this).is(":checked"))}),$("#removeRouteHighlight").click(function(t){e.setHighlightType(e.highlightTypes.basic),e.renderHighlightedRoute()}),$("#showSpeedBasedRoute").click(function(t){e.setHighlightType(e.highlightTypes.speed),e.renderHighlightedRoute()}),$("#showZoneBasedRoute").click(function(t){e.setHighlightType(e.highlightTypes.heartRate),e.renderHighlightedRoute()}),$("#showRacePaceBasedRoute").click(function(t){e.setHighlightType(e.highlightTypes.racepace),e.renderHighlightedRoute()}),$.dispatcher.on("superGraph.rangeChanged",function(t,s){if(!s.range.isDragged){var i=Math.max(0,this.getMapIndex(s.range.start)),a=this.getMapIndex(s.range.stop);a===-1&&(a=Math.max(0,e.model.samples?this.model.samples.length-1:0)),s.range.lapIndex==-1&&(this.selectedLap=void 0,this.$showMarkers.prop("disabled",!1).parent().removeClass("disabled")),this.setSelectedRange(i,a)}}.bind(this)),$.dispatcher.on("superGraph.tooltip",function(t,s){e.setPosition(e.getMapIndex(s.timestamp))}.bind(this)),$.dispatcher.on("laps.selectLapType",function(e,t){t.phasesShown===!0?this.showPhases(t.lapDataValues,t.hasLapsAndPhases):this.showLaps(t.lapDataValues,t.hasLapsAndPhases)}.bind(this)),$.dispatcher.on("sportList.selectSport",function(e,t){this.selectExercise(t.exerciseId)}.bind(this)),$.dispatcher.on("sportList.unselectSport",function(e,t){this.unselectExercise()}.bind(this))},LMap.prototype.getMapIndex=function(e){if(e&&this.model){var t=this.model.samples;if(t&&t.length>0)for(var s=0;s<t.length;s++)if(t[s][SampleKeys.TIME]>=e)return s}return-1},LMap.prototype.setHighlightType=function(e){this.highlightType=e},LMap.prototype.setShowMarkers=function(e){this.showMarkers=e,this.renderHighlightedRoute()},LMap.prototype.setSelectedRange=function(e,t){this.selectedRange={start:e,stop:t},this.renderHighlightedRoute()},LMap.prototype.setPosition=function(e){e>=0?(this.position=e,this.renderPosition()):(this.position=-1,this.positionMarker&&(this.map.removeLayer(this.positionMarker),this.positionMarker=null),this.racePacePositionMarker&&(this.map.removeLayer(this.racePacePositionMarker),this.racePacePositionMarker=null))},LMap.prototype.renderPosition=function(){if(this.positionMarker?this.positionMarker.setLatLng(this.highlightedRoute.points[this.position]):this.positionMarker=L.marker(this.highlightedRoute.points[this.position],{icon:this.icons.position,zIndexOffset:300}).addTo(this.map),"STEADY_RACE_PACE"===this.model.exercises[exerciseID][ExerciseKeys.EXERCISE_TARGET_TYPE]){var e=store.getRacePaceData().racepaceSamples[exerciseID].RACE_PACE_INDEX[this.position],t=this.highlightedRoute.points[e];this.racePacePositionMarker?this.racePacePositionMarker.setLatLng(t):this.racePacePositionMarker=L.marker(t,{icon:this.icons.racepace,zIndexOffset:301}).addTo(this.map)}},LMap.prototype.selectExercise=function(e){if(this.toggleHighlightMapSettings(!0),this.selectedExercise=this.model.exercises[e],this.selectedRange=null,this.selectedLaps=null,Zones.speed=this.selectedExercise[ExerciseKeys.SPEED_ZONES],Zones.heartRate=this.selectedExercise[ExerciseKeys.HR_ZONES],Zones.power=this.selectedExercise[ExerciseKeys.POWER_ZONES],null!=this.selectedExercise){this.model.samples&&this.model.samples.length>0&&(this.toggleHighlightMapSettings(!0),this.setHighlightType(this.highlightTypes.basic),this.renderHighlightedRoute());LMapHelpers.getExerciseDistance(this.selectedExercise,this.model.samples)>50&&!CommonHelpers.context.coach&&isFlowUser&&($("#addFavoriteRoute").remove(),new Favorites($("#mapCanvasLeaflet")).Route(e).showControls())}},LMap.prototype.unselectExercise=function(){this.selectedExercise=null,this.selectedRange=null,this.selectedLaps=null,this.toggleHighlightMapSettings(!1),$("#addFavoriteRoute").remove(),this.setHighlightType(this.highlightTypes.basic),this.renderHighlightedRoute()},LMap.prototype.toggleHighlightMapSettings=function(e){var t=$("#mapSettingsHighlightRouteLabel");t.removeClass(e?"hidden":"visible"),t.addClass(e?"visible":"hidden");var s=$("#mapSettingsHighlightRoute");s.removeClass(e?"hidden":"visible"),s.addClass(e?"visible":"hidden"),"STEADY_RACE_PACE"===this.model.exercises[exerciseID][ExerciseKeys.EXERCISE_TARGET_TYPE]?$("#showRacePaceBasedRoute").prop("checked",!0):$("#removeRouteHighlight").prop("checked",!0)},LMap.prototype.showPhases=function(e,t){this.markers=Markers.phases,this.setMarkers(e);var s=$("#showMarkersText");t?s.html(s.data("both")):s.html(s.data("phases"))},LMap.prototype.showLaps=function(e,t){this.markers=Markers.laps,e&&this.setMarkers(e);var s=$("#showMarkersText");t?s.html(s.data("both")):s.html(s.data("laps"))},LMap.prototype.setMarkers=function(e){if(this.selectedExercise){this.selectedLap=null,this.selectedRange=null,this.selectedLaps=[];for(var t=0;t<e.length;t++)this.selectedLaps[t]={},this.selectedLaps[t].lapNumber=e[t].lapNumber+1,this.selectedLaps[t].lapSampleIndex=this.getMapIndex(e[t].stopTime),this.selectedLaps[t].startTime=e[t].startTime,this.selectedLaps[t].stopTime=e[t].stopTime;this.renderHighlightedRoute()}},LMap.prototype.renderHighlightedRoute=function(){this.highlightedRoute&&(this.selectedRange?this.highlightedRoute.setSelectedRange(this,this.selectedRange.start,this.selectedRange.stop,!0):this.highlightedRoute.setSelectedRange(this,null,null,!0))},LMap.prototype.openFullscreenMap=function(){var e=this;$(".navigation").hide();var t=$("#mapFullscreenHeader");t.removeClass("hidden"),t.addClass("visible"),$(window).scrollTop(1);var s=$("#mapComponentContainer");s.css({position:"fixed",marginLeft:0,marginTop:0,top:0,left:0,height:"100%",width:"100%",zIndex:1e3}),s.parent().addClass("full-screen-map"),$("#mapCanvasLeaflet").css({width:"100%",height:"100%",margin:0,position:"absolute",top:0}),$(".mapbox-logo").css({top:"80px"}),$("#resetFullScreenMap").show(),setTimeout(function(){e.map.invalidateSize(),e.fitBounds()},200),e.map.dragging.enable(),e.map.scrollWheelZoom.enable();var i=0;$(window).scroll(function(){i>2&&$("#removeFullScreenMap").trigger("click"),i++}),$("#fullScreenMap").hide(),$("#removeFullScreenMap").show()},LMap.prototype.closeFullscreenMap=function(){var e=this;$(".navigation").show();var t=$("#mapFullscreenHeader");t.removeClass("visible"),t.addClass("hidden");var s=$("#mapComponentContainer");s.removeAttr("style"),s.parent().removeClass("full-screen-map"),$("#mapCanvasLeaflet").css({width:"100%",height:"300px",position:"relative"}),$(".mapbox-logo").css({top:"0px"}),setTimeout(function(){e.map.invalidateSize(),e.fitBounds()},200),AppGlobal.isMobile&&e.map.dragging.disable(),e.map.scrollWheelZoom.disable(),$(window).unbind("scroll"),$("#fullScreenMap").show(),$("#removeFullScreenMap").hide()}}();
//# sourceMappingURL=leafletMap.min.js.map