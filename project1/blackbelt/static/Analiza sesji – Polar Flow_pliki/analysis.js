Analysis=function(){this.options={timeBased:!0,metricUnits:!0,speedUnits:"SPEED",fullscreen:!1},this.racePaceMarker=null,this.selectedData=null,this.charts=new AnalysisCharts(this),this.charts.init(),this.graph=null,this.timestamps=null,this.distances=null,this.distanceSamplesOffset=0,this.datasets=[],this.phases=null,this.zoneGroups=null,this.bindEvents()},Analysis.prototype.bindEvents=function(){var e=this;$.dispatcher.on("store.dataLoaded",function(s,t){var a=this.charts.getCharts(),i=null,n=null,r=0,l=SuperGraph.MARKER.off,o={laps:[],phases:[],swimming:[],multisport:[],racepace:null};if("METRIC"===CommonHelpers.units?e.options.metricUnits=!0:e.options.metricUnits=!1,t.isSingleSport)e.selectedData=store.getSelectedExercise(),e.options.selectedExercise=e.selectedData.id,e.options.speedUnits=e.selectedData.sportTypeSpeed?"SPEED":"PACE",i=e.selectedData.durationBasedSamples,n=e.selectedData.distanceBasedSamples,e.selectedData.swimmingSport&&(e.options.speedUnits="SWIMMING",e.selectedData.hasSwimmingSamples&&(e.options.timeBased=!1),e.selectedData.poolUnits&&("METERS"===e.selectedData.poolUnits?e.options.metricUnits=!0:e.options.metricUnits=!1)),a.forEach(function(e){i[e.id]?e.hasData=!0:e.hasData=!1});else{e.selectedData=store.getTrainingSession();var p=e.combineMultisportSamples();i=p.durationSamples,n=p.distanceSamples,o.multisport=p.markers}if(i){var c=null;for(var h in i)if(i[h]&&i[h][0]&&i[h][0].length>0){c=i[h][0];break}var d=null;if(n)for(var h in n)if(n[h]&&n[h][0]&&n[h][0].length>0){d=n[h][0];break}if(c&&d){if(e.selectedData.hasSwimmingSamples)for(var m=d[d.length-1];d.length<c.length;)d.push(m);else for(this.distanceSamplesOffset=c.length-d.length;d.length<c.length;)d.unshift(d[0]);for(var n=[],u=0;u<d.length;u++)n.push([c[u][0],d[u][0]]);n.length>0&&(a.forEach(function(e){"DISTANCE"==e.id&&(e.hasData=!0)}),i.DISTANCE=[],i.DISTANCE[0]=n)}var f=[];if(e.timestamps=this.parseTimestampsFromSomeData(c),e.distances=this.parseDistancesFromSomeData(d),null!=e.timestamps||null!=e.distances){null!=e.timestamps?r=e.timestamps.length-2:null!=e.distances&&(r=e.distances.length-2),e.distances&&e.distances.length>0&&e.distances.push(e.distances[e.distances.length-1]),o.swimming=this.parseSwimmingPhases(),o.swimming&&o.swimming.length>0&&(f.push({id:SuperGraph.MARKER.swimming,label:Messages["diary.result.swimming_indoor.swimming_phases"],show:!0}),l=SuperGraph.MARKER.swimming),o.racepace=this.parseRacePaceSamples(i,0),this.zoneGroups=this.parseZoneGroups();var g=this.zoneGroups,S=this.parseTargetResult();o.phases=S.phaseMarkers,this.phases=S.phases,a.forEach(function(e){if(e.children){var s=!1;e.children.forEach(function(e){i[e.id]&&(s=!0)}),e.hasData=!!s}else i[e.id]?e.hasData=!0:e.hasData=!1}),a.forEach(function(s){if(s.hasData)if(s.colorLight=AnalysisHelpers.shadeColor(s.color,.5),s.zoneIds&&(s.zoneIndex?(!g[s.zoneIds[s.zoneIndex]]||g[s.zoneIds[s.zoneIndex]].data.length<1)&&(s.zoneIndex=0):s.zoneIndex=0,s.showZones=!!g[s.zoneIds[s.zoneIndex]],s.zones=s.showZones?g[s.zoneIds[s.zoneIndex]].data:null,s.showPhases=!!e.phases[s.zoneIds[0]],s.phases=e.phases[s.zoneIds[0]]),s.children){var t=!1,a=$.extend(!0,{},s);a.children.forEach(function(e){if(i[e.id]){t=!0;var s=[];i[e.id][0].forEach(function(e){s.push(e[1])}),e.data=s,e.avg=0,e.total=0}}),t&&(a.max=Number.NEGATIVE_INFINITY,a.min=Number.MAX_VALUE,e.datasets.push(a))}else if(i[s.id]){var a=$.extend(!0,{},s),n=[];i[s.id][0].forEach(function(e){n.push(e[1])}),a.data=n,a.max=Number.NEGATIVE_INFINITY,a.min=Number.MAX_VALUE,a.avg=0,a.total=0,e.datasets.push(a)}}),o.multisport&&o.multisport.length>0&&f.push({id:SuperGraph.MARKER.multisport,label:Messages["settings.sport_profiles.display_item_category.multisport"],show:!0}),f.length>0&&(f.push({id:SuperGraph.MARKER.off,label:Messages["bikepower.analysisview.graph.settings.show.zones_Off"],show:!0}),l=f[0].id),e.disableZoneSwitchForDataset("ALTITUDE"),this.graph=new SuperGraph(this,{timestamps:this.timestamps,distances:this.distances,datasets:this.datasets,markerTypes:f,markers:o,zoneGroups:g,minIndex:0,maxIndex:r,startIndex:0,stopIndex:r,defaultMarkers:l,distanceSamplesOffset:this.distanceSamplesOffset}),this.graph.init()}}}.bind(this))},Analysis.prototype.disableZoneSwitchForDataset=function(e){this.datasets.forEach(function(s){s.id===e&&(s.ignoreZoneSwitch=!0)})},Analysis.prototype.parseRacePaceSamples=function(e,s){var t=this,a=null,i=null;if(store.getSelectedExercise()&&(a=store.getExerciseTargetResults()),a&&a.racePaceTarget){var n=exerciseTargetResults[exerciseID],r=[];if(t.timestamps.forEach(function(e,i){var n=(e-t.timestamps[s])/36e5*a.racePaceSpeed,l=t.distances[i]/1e3,o=l-n;r.push([0,o])}),e[AnalysisCharts.IDS.racePace]=[],e[AnalysisCharts.IDS.racePace][0]=r,n){var l=t.getIndexByDistance(t.distances[s]+n.distance,!0);i={type:SuperGraph.MARKER.racepace,time:t.timestamps[l],distance:t.distances[l],speed:a.racePaceSpeed,alignRight:!0},t.racePaceMarker=i}}return i},Analysis.prototype.parseSwimmingPhases=function(){if(this.selectedData.swimmingSport){var e=this,s=store.getPhasesData(),t=[];if(s&&s[e.selectedData.id]){var a=s[e.selectedData.id],i=a.phases.length-1,n=1,r={number:n,id:-1};return a.phases.forEach(function(s,a){r.id!=s.phaseId?(r.id!=-1&&(r.start.distance==r.stop.distance?r.isRestTime=!0:r.isRestTime=!1,t.push(r),n++),r={type:SuperGraph.MARKER.swimming,label:s.style,number:n,id:s.phaseId,start:{index:-1,time:1e3*Math.floor((e.timestamps[0]+s.startSplitTime.millis)/1e3),timeFromStart:s.startSplitTime.millis,distance:s.startDistance},stop:{index:-1,time:1e3*Math.floor((e.timestamps[0]+s.startSplitTime.millis+s.duration.millis)/1e3),timeFromStart:s.startSplitTime.millis+s.duration.millis,distance:s.startDistance+s.distance}},r.start.index=Math.floor(r.start.timeFromStart/1e3),r.stop.index=Math.floor(r.stop.timeFromStart/1e3)):(r.stop.time=1e3*Math.floor((e.timestamps[0]+s.startSplitTime.millis+s.duration.millis)/1e3),r.stop.timeFromStart=s.startSplitTime.millis+s.duration.millis,r.stop.distance=s.startDistance+s.distance,r.stop.index=Math.floor(r.stop.timeFromStart/1e3)),a==i&&t.push(r)}),t}}return null},Analysis.prototype.getIndexByTime=function(e,s){var t;t=s?1e3*Math.round(e/1e3):e;for(var a=0;a<this.timestamps.length;a++)if(this.timestamps[a]>=t)return a;return t>this.timestamps[this.timestamps.length-1]?this.timestamps.length-1:-1},Analysis.prototype.getDistanceByTime=function(e){var s=this,t=s.getIndexByTime(e,!0);return s.distances?s.distances[t]:0},Analysis.prototype.getIndexByDistance=function(e,s){if(s){for(var t=0;t<this.distances.length;t++)if(this.distances[t]>=e)return t}else for(var t=this.distances.length-1;t>=0;t--)if(e>=this.distances[t])return t;return e>this.distances[this.distances.length-1]?this.distances.length-1:-1},Analysis.prototype.parseTimestampsFromSomeData=function(e){if(e){var s=[];if(e.forEach(function(e){s.push(e[0])}),s.length>0){var t=1e3,a=s.length-1;s.length>1&&(t=s[1]-s[0]),s.push(s[a]+t)}return s}return null},Analysis.prototype.parseDistancesFromSomeData=function(e){if(e){var s=[];return e.forEach(function(e){s.push(e[0])}),s}return null},Analysis.prototype.parseZoneGroups=function(){var e=store.getZonesJson(),s=null,t=null,a=null,i=null,n=[],r=[];if(n[0]={acolor:AnalysisHelpers.COLORS.ZONES.HILLS.acolor,color:AnalysisHelpers.COLORS.ZONES.HILLS.color,value:1,from:AnalysisHelpers.hillTypeToNumeric("DOWNHILL"),to:AnalysisHelpers.hillTypeToNumeric("FLAT")},n[1]={acolor:AnalysisHelpers.COLORS.ZONES.HILLS.acolor,color:AnalysisHelpers.COLORS.ZONES.HILLS.color,value:2,from:AnalysisHelpers.hillTypeToNumeric("FLAT"),to:AnalysisHelpers.hillTypeToNumeric("UPHILL")},n[2]={acolor:AnalysisHelpers.COLORS.ZONES.HILLS.acolor,color:AnalysisHelpers.COLORS.ZONES.HILLS.color,value:3,from:AnalysisHelpers.hillTypeToNumeric("UPHILL"),to:AnalysisHelpers.hillTypeToNumeric("UPHILL")},r[AnalysisCharts.ZONEIDS.hills]={label:"Hills",data:n},e.HEART_RATE&&e.HEART_RATE.trainingZoneList){s=[];for(var l=AnalysisHelpers.COLORS.ZONES.HR,o=Math.min(l.length,e.HEART_RATE.trainingZoneList.length),p=0;p<o;p++)s.push({acolor:l[p].acolor,color:l[p].color,from:e.HEART_RATE.trainingZoneList[p].lower,to:e.HEART_RATE.trainingZoneList[p].upper,value:p+1});r[AnalysisCharts.ZONEIDS.heartRate]={label:Messages["analyseview.chart.settings.heart.rate"],data:s}}if(e.FITFAT&&e.FITFAT.trainingZoneList){i=[];for(var l=AnalysisHelpers.COLORS.ZONES.FITFAT,o=Math.min(l.length,e.FITFAT.trainingZoneList.length),p=0;p<o;p++)0==e.FITFAT.trainingZoneList[p].lower&&0==e.FITFAT.trainingZoneList[p].upper||i.push({acolor:l[p].acolor,color:l[p].color,from:e.FITFAT.trainingZoneList[p].lower,to:e.FITFAT.trainingZoneList[p].upper,value:p+1,title:0==p?Messages["analyseview.sport.fitfat.fat"]:Messages["analyseview.sport.fitfat.fit"]});i.length>0&&(r[AnalysisCharts.ZONEIDS.fitFat]={label:Messages["analyseview.chart.settings.fitFat"],data:i},this.charts.charts[0].zoneIds.push(AnalysisCharts.ZONEIDS.fitFat))}if(e.SPEED&&e.SPEED.trainingZoneList){t=[];for(var l=AnalysisHelpers.COLORS.ZONES.SPEED,o=Math.min(l.length,e.SPEED.trainingZoneList.length),p=0;p<l.length;p++)t.push({acolor:l[p].acolor,color:l[p].color,from:e.SPEED.trainingZoneList[p].lower,to:e.SPEED.trainingZoneList[p].upper,value:p+1});r[AnalysisCharts.ZONEIDS.speed]={label:"SPEED"===this.options.speedUnits?Messages["curves.type.speed"]:Messages["curves.type.pace"],data:t}}if(e.POWER&&e.POWER.trainingZoneList){a=[];for(var l=AnalysisHelpers.COLORS.ZONES.POWER,o=Math.min(l.length,e.POWER.trainingZoneList.length),p=0;p<l.length;p++)a.push({acolor:l[p].acolor,color:l[p].color,from:e.POWER.trainingZoneList[p].lower,to:e.POWER.trainingZoneList[p].upper,value:p+1});r[AnalysisCharts.ZONEIDS.power]={label:Messages["curves.type.power"],data:a}}return r},Analysis.prototype.parseTargetResult=function(){var e=null;store.getSelectedExercise()&&(e=store.getExerciseTargetResults());var s=[],t=[],a=this.zoneGroups,i=this;if(e){if(e.racePaceTarget){var n=[{acolor:"rgba(209, 0, 39, .3)",color:CommonHelpers.routeRacePaceAheadHighlightColor,from:null,to:0,value:1,title:Messages["race.pace.flow.analysis.view.behind"]},{acolor:"rgba(47, 193, 106, .3)",color:CommonHelpers.routeRacePaceBehindHighlightColor,from:0,to:null,value:2,title:Messages["race.pace.flow.analysis.view.ahead"]}];a[AnalysisCharts.ZONEIDS.racePace]={label:Messages["race.pace.analysis.markers.race_pace"],data:n}}switch(e.type){case"PHASED":case"STRENGTH":e.exercisePhasedTargetData&&e.exercisePhasedTargetData.forEach(function(e){s[e.zoneType]||(s[e.zoneType]=[]);for(var n=e.lowerZone;n<=e.upperZone;n++)a[e.zoneType]&&s[e.zoneType].push({color:AnalysisHelpers.addAlpha(a[e.zoneType].data[n-1].color,.4),from:a[e.zoneType].data[n-1].from,to:a[e.zoneType].data[n-1].to,start:{time:i.timestamps[0]+e.startSplitTime.millis,distance:i.distances?i.distances[0]+e.startSplitDistance:null},stop:{time:i.timestamps[0]+e.splitTime.millis,distance:i.distances?i.distances[0]+e.splitDistance:null}});for(var r=i.timestamps[0]+e.splitTime.millis,l=!1,n=0;n<t.length;n++)t.time===r&&(l=!0);l||(t.push({number:0,time:i.timestamps[0]+e.startSplitTime.millis,distance:i.distances?i.distances[0]+e.startSplitDistance:null,x:0,type:SuperGraph.MARKER.phase,showNumber:!1}),t.push({number:0,time:r,distance:i.distances?i.distances[0]+e.splitDistance:null,x:0,type:SuperGraph.MARKER.phase,showNumber:!0}))})}}return{phases:s,phaseMarkers:t}},Analysis.prototype.combineMultisportSamples=function(){var e=[],s=[],t=[],a=[],i=this,n=null;return this.selectedData.exercises.forEach(function(r){a.push({start:{time:r.startTime,distance:r.startDistance},x:0,type:SuperGraph.MARKER.multisport}),a.push({start:{time:r.startTime,distance:r.startDistance},stop:{time:r.stopTime,distance:r.stopDistance},x:0,width:0,text:r.sport.name,type:SuperGraph.MARKER.multisport}),a.push({start:{time:r.stopTime,distance:r.stopDistance},x:0,type:SuperGraph.MARKER.multisport});var l=null,o=0,p=0;i.charts.charts.forEach(function(e){r.durationBasedSamples[e.id]&&(o=r.durationBasedSamples[e.id][0].length,r.distanceBasedSamples&&r.distanceBasedSamples[e.id]&&(p=r.distanceBasedSamples[e.id][0].length),l=e.id)}),i.charts.charts.forEach(function(a){if(r.durationBasedSamples[a.id])t.indexOf(a.id)<0&&t.push(a.id),e[a.id]||(e[a.id]=[],e[a.id][0]=[]),e[a.id][0]=e[a.id][0].concat(r.durationBasedSamples[a.id][0]);else if(o>0){e[a.id]||(e[a.id]=[],e[a.id][0]=[]);for(var i=0;i<o;i++)e[a.id][0].push([r.durationBasedSamples[l][0][i][0],null])}if(r.distanceBasedSamples&&r.distanceBasedSamples[a.id])t.indexOf(a.id)<0&&t.push(a.id),s[a.id]||(s[a.id]=[],s[a.id][0]=[]),s[a.id][0]=s[a.id][0].concat(r.distanceBasedSamples[a.id][0]),n=s[a.id][0][s[a.id][0].length-1][0];else if(o>0)if(s[a.id]||(s[a.id]=[],s[a.id][0]=[]),null!=n&&o>p)for(var i=0;i<o;i++)s[a.id][0].push([n,null]);else for(var i=0;i<p;i++)s[a.id][0].push([r.distanceBasedSamples[l][0][i][0],null])})}),this.charts.charts.forEach(function(a){t.indexOf(a.id)>=0?a.hasData=!0:(a.hasData=!1,e[a.id]=null,s[a.id]=null)}),{durationSamples:e,distanceSamples:s,markers:a}},Analysis.prototype.getCharts=function(){return this.charts.getCharts()},Analysis.prototype.getRacePaceMarker=function(){return this.racePaceMarker};
//# sourceMappingURL=analysis.min.js.map