SuperGraph=function(t,e){this.parent=t,this.options=t.options,this.datasets=e.datasets,this.timestamps=e.timestamps,this.distances=e.distances,this.distanceSamplesOffset=e.distanceSamplesOffset,this.zoneGroups=e.zoneGroups,this.markerTypes=e.markerTypes,this.startIndex=e.startIndex,this.stopIndex=e.stopIndex,this.minIndex=e.minIndex,this.maxIndex=e.maxIndex,this.markersEnabled=!0,this.markersType=e.defaultMarkers,this.markers=e.markers,this.rangeStatistics=new RangeStatistics(this),this.resizeTimeout=null,this.xAxis={numberOfLabels:5,labelInterval:36e5,labels:[],values:null,total:null,datasets:[]},this.id="analysis2Graph",this.marginLeft=50,this.marginRight=195,this.marginTop=0,this.marginBottom=0,this.marginBetween=10,this.chartHeightWithZones=110,this.chartHeightWithoutZones=60,this.canvasLeft=0,this.canvasRight=0,this.canvasHeight=0,this.canvasWidth=0,this.dragStart=-1,this.dragStop=-1,this.rangeSliderActive=!1,this.selectedLapIndex=-1,this.selectedData=null;var s=this;this.xAxis.datasets.DURATION={id:"DURATION",label:Messages["common.duration"],icon:"icon-duration",formatUnit:function(){return""},format:function(t){return DateUtils.millisToThreeDigitTime(t)},data:[]},this.xAxis.datasets.DISTANCE={id:"DISTANCE",label:Messages["common.distance"],icon:"icon-distance",formatUnit:function(){return"SWIMMING"===s.options.speedUnits?s.options.metricUnits?Messages["common.abbreviations.unitOfMeters"]:Messages["diary.result.swimming_indoor.unitOfYards"]:s.options.metricUnits?Messages["common.abbreviations.unitOfKilometers"]:Messages["common.abbreviations.unitOfMiles"]},format:function(t){return"SWIMMING"===s.options.speedUnits?s.options.metricUnits?CommonHelpers.round(t,0).toFixed(0):CommonHelpers.round(t*CommonHelpers.oneMeterAsYards,1).toFixed(1):s.options.metricUnits?CommonHelpers.round(t/1e3,2).toFixed(2).replace(".",","):CommonHelpers.round(t/CommonHelpers.oneMileAsKm/1e3,2).toFixed(2)},data:[]},this.options.timeBased?this.xAxis.values=this.timestamps:this.xAxis.values=this.distances},SuperGraph.MARKER={off:0,lap:1,phase:2,multisport:3,swimming:4,racepace:5},SuperGraph.prototype.init=function(){var t=_.template($("#templateSuperGraph").html());$(".supergraph-wrapper").html(t({id:this.id,height:this.canvasHeight,marginTop:this.marginTop})),this.wrapper=$(".supergraph-wrapper"),this.$dom=$("#"+this.id),this.$left=this.$dom.find(".supergraph-left"),this.middle=this.$dom.find(".supergraph-middle"),this.right=this.$dom.find(".supergraph-right"),this.canvas=this.middle.find(".supergraph-canvas"),this.canvasLabels=this.middle.find(".supergraph-canvas-labels"),this.tooltip=this.middle.find(".supergraph-tooltip-container"),this.selection=this.middle.find(".supergraph-selection"),this.crosshair=this.middle.find(".supergraph-crosshair"),this.rangeSlider=this.middle.find(".supergraph-rangeslider"),this.rangeSliderTooltip=this.middle.find(".supergraph-rangeslider-tooltip"),this.markersContainer=this.middle.find(".supergraph-markers"),this.controls=this.wrapper.find(".supergraph-controls-right"),this.setMargins();var e=this.wrapper[0].offsetWidth-this.wrapper[0].clientWidth;this.wrapper.find(".supergraph").css("margin-right",e+"px"),this.canvasWidth=this.$dom.width()-this.marginLeft-this.marginRight-e,this.canvasTop=this.marginTop,this.canvasLeft=this.canvas.position().left,this.canvasRight=this.canvasLeft+this.canvasWidth,this.c=document.querySelector("#"+this.id+" > .supergraph-middle > .supergraph-canvas"),this.ctx=this.c.getContext("2d"),this.setRightMargins(),this.setMargins(),this.hideTooltip();var s=this;this.resetMinMax(),this.filterData(),this.drawSettings(),this.rangeSlider.slider({range:!0,min:s.minIndex,max:s.maxIndex,values:[s.startIndex,s.maxIndex+1],slide:function(t,e){var a=!1;s.stopIndex!=e.values[1]&&(a=!0),s.startIndex=e.values[0],s.stopIndex=e.values[1],s.selectedLapIndex!==-1&&(s.selectedLapIndex=-1),s.rangeChanged(!0);var i=s.getTooltipElementsBottom(a?s.stopIndex:s.startIndex),r=_.template($("#templateRangesliderTooltip").html());s.rangeSliderTooltip.html(r({rows:i}));var n=$(".ui-slider-handle.ui-state-active").position().left-s.rangeSliderTooltip.width()/2-5;s.rangeSliderTooltip.css("transform","translate("+n+"px, 0px)"),s.showTooltip(a?s.canvasWidth:0,!1)},start:function(t,e){s.rangeSliderActive=!0,s.canvasLabels.hide();var a=!1;s.rangeSlider.find(".ui-slider-handle").each(function(t,e){$(this).hasClass("ui-state-hover")&&(a=0!==t)});var i=s.getTooltipElementsBottom(a?s.stopIndex:s.startIndex),r=_.template($("#templateRangesliderTooltip").html());s.rangeSliderTooltip.html(r({rows:i})),s.rangeSliderTooltip.show(),s.rangeSliderTooltipUpdater=setInterval(function(){var t=$(".ui-slider-handle.ui-state-active").position().left-s.rangeSliderTooltip.width()/2-5;s.rangeSliderTooltip.css("transform","translate("+t+"px, 0px)")},30)},stop:function(t,e){s.rangeSliderActive=!1,s.rangeSliderTooltipUpdater&&(clearInterval(s.rangeSliderTooltipUpdater),s.rangeSliderTooltipUpdater=null),s.canvasLabels.show(),s.rangeSliderTooltip.hide(),s.calculateZones(),s.resetMinMax(),s.rangeChanged(!1),s.filterData(),s.draw(!1)}}),this.calculateZones(),this.updateCanvasHeight(!1),this.draw(!1),this.bindEvents()},SuperGraph.prototype.getIndex=function(t){if(0===t)return this.startIndex;if(t===this.canvasWidth)return this.stopIndex;for(var e=this.xAxis.values[this.startIndex]+t/this.canvasWidth*this.xAxis.total,s=1;s<this.xAxis.values.length;s++)if(this.xAxis.values[s]>=e)return s-1;return-1},SuperGraph.prototype.getTooltipElementsBottom=function(t){var e=this.xAxis.datasets.DURATION.format(this.timestamps[t]-this.timestamps[this.minIndex]),s={id:"BOTTOM_DURATION",value:e,unit:"",color:null},a=null;if(this.distances&&this.distances.length>0){a={id:"BOTTOM_DISTANCE",value:this.xAxis.datasets.DISTANCE.format(this.distances[t]-this.distances[this.minIndex]),unit:this.xAxis.datasets.DISTANCE.unit,color:null}}var i=[];return this.options.timeBased?(i.push(s),a&&i.push(a)):(a&&i.push(a),i.push(s)),i},SuperGraph.prototype.getTooltipElements=function(t,e,s){var a=[];if(t>=0){var i=0,r=this;if(this.datasets.forEach(function(s){if(s.show){var n=s.showZones?r.chartHeightWithZones:r.chartHeightWithoutZones;if(s.children){var o=[];s.children.forEach(function(a){if(a.data){var h=r.calculateTooltipYOffset(a.data,s.min,s.max,t,i,e,n);null!=a.data[t]&&o.push({id:a.id,value:a.format(a.data[t]),unit:s.hideTooltipUnit?"":a.unit,prefix:a.prefix,color:a.color,y:h>=i&&h<=i+n?h:-1})}}),o.length>0&&a.push({id:s.id,values:o,y:i,x:e,zoneColor:null})}else{var h=null;if(s.showZones)for(var l=s.zones.length-1;l>=0;l--){var p=s.zones[l],d=s.data[t];if(d>=p.from&&d<=p.to){h=p.color;break}}var c=r.calculateTooltipYOffset(s.data,s.min,s.max,t,i,e,n);null!=s.data[t]&&(a.push({id:s.id,values:[{id:s.id,value:s.format(s.data[t]),unit:s.hideTooltipUnit?"":s.unit,prefix:s.prefix,color:s.color,y:c>=i&&c<=i+n?c:-1}],y:i,x:e,zoneColor:h}),"ALTITUDE"===s.id&&r.includeAngleInAltitudeTooltipElement(a[a.length-1],s,t,e,c>=i&&c<=i+n?c:-1))}i+=n+2*r.marginBetween}}),s){var n=this.getTooltipElementsBottom(t);a.push({id:"BOTTOM_DURATION",values:n,y:r.canvasHeight,x:e,zoneColor:null,class:"supergraph-tooltip__bottom"})}}return a},SuperGraph.prototype.calculateTooltipYOffset=function(t,e,s,a,i,r,n){var o=null;if(a<t.length-1){var h=i+n-(t[a+1]-e)/(s-e)*n,l=(this.xAxis.values[a+1]-this.xAxis.values[this.startIndex])/this.xAxis.total*this.canvasWidth,p=i+n-(t[a]-e)/(s-e)*n;o=p+(1-(l-r)/(l-(this.xAxis.values[a]-this.xAxis.values[this.startIndex])/this.xAxis.total*this.canvasWidth))*(h-p)}else o=i+n-(t[a]-e)/(s-e)*n;return o},SuperGraph.prototype.includeAngleInAltitudeTooltipElement=function(t,e,s,a,i){var r=this,n=(r.stopIndex-r.startIndex)/r.canvasWidth,o=[];if(n<=1)for(var h=Math.max(r.minIndex,s-10),l=Math.min(r.maxIndex,s+10),p=h;p<l;p++)o.push(p);else for(var d=Math.max(0,a-5),c=Math.min(r.canvasWidth,a+5),m=d;m<c;m++)o.push(r.getIndex(m));var x=o.map(function(t){return{x:r.distances[t],y:e.data[t]}}),u=AnalysisHelpers.calculateTrendline(x),g=u.slopeAngle>=0?'<i class="icon icon-ascent-angle" style="font-size: 16px;"></i>':'<i class="icon icon-descent-angle" style="font-size: 16px;"></i>';t.values.push({id:e.id+"_ANGLE",value:u.slopeAngle,unit:"&deg;",prefix:g,color:e.color,y:i,disablePrefixColor:!0})},SuperGraph.prototype.drawSettings=function(){var t=this,e=_.template($("#templateGraphSettings").html()),s=e({charts:this.datasets,zoneGroups:this.zoneGroups,markers:this.markerTypes,markersEnabled:this.markersEnabled,timeBased:this.options.timeBased,hasDistanceSamples:!!this.distances}),a=function(){$(".supergraph-settings__chart").on("click",function(e){e.preventDefault();var s=$(this),a=s.data("id");t.showOrHideChart(a)?(s.addClass("active"),$(".supergraph-settings__zone[data-chart="+a+"]").removeClass("disabled")):(s.removeClass("active"),$(".supergraph-settings__zone[data-chart="+a+"]").addClass("disabled")),t.setRightMargins(),t.draw(!1)}),$(".supergraph-settings__zone").on("click",function(e){e.preventDefault();var s=$(this),a=s.data("value"),i=s.data("chart"),r=t.datasets[t.getDatasetIndex(i)];if(a){for(var n=s.data("id"),o=0,h=0;h<r.zoneIds.length;h++)r.zoneIds[h]==n&&(o=h);r.zoneIndex=o,r.zones=t.zoneGroups[n].data,r.showZones=!0}else r.zoneIndex=-1,r.showZones=!1;s.parent().find(".active").removeClass("active"),s.addClass("active"),t.setRightMargins(),t.calculateZones(),t.resetMinMax(),t.updateCanvasHeight(!1)}),$("#xAxisValue > li").on("click",function(e){e.preventDefault();var s="distance"!==$(this).data("value");s!==t.options.timeBased&&(t.options.timeBased=s,t.options.timeBased?t.xAxis.values=t.timestamps:t.xAxis.values=t.distances,t.xAxis.total=t.xAxis.values[t.stopIndex]-t.xAxis.values[t.startIndex],t.xAxis.totalHidden=t.xAxis.values[t.maxIndex]-t.xAxis.values[t.minIndex],t.calculateZones(),t.resetMinMax(),t.clearMarkers(),t.formatUnitsAndLabels(),t.draw(!1),$("#xAxisValue > li").removeClass("active"),$(this).addClass("active"))}),$("#settingAverages > li").on("click",function(e){var s=$(this).data("value");s!=t.showAverages&&(t.showAverages=s,t.draw(!1)),$("#settingAverages > li").removeClass("active"),$(this).addClass("active")}),$("#settingMarkers > li").on("click",function(e){$("#settingMarkers > li").removeClass("active"),$(this).addClass("active"),t.markersEnabled=!t.markersEnabled,t.clearMarkers(),t.draw(!1)})};new PolarModal("settings",Messages["analyseview.chart.settings.header"],s,"",a)},SuperGraph.prototype.drawSingle=function(t,e,s,a,i,r,n){var o=this,h=0;o.ctx.fillStyle=CommonHelpers.backgroundColor,o.ctx.strokeStyle=t.color;var l=null;if(!e||s<1e3||null==t.filtered){for(var p=[],d=-1,c=o.startIndex;c<=o.stopIndex;c++)if(h=(o.xAxis.values[c]-o.xAxis.values[o.startIndex])/o.xAxis.total*o.canvasWidth,null!=t.data[c]){d===-1&&(d=c);var m=a+i-(t.data[c]-n)/r*i;p.push({y:m,x:h,index:c,startIndex:d})}else{if(c>0)if(t.type!=AnalysisCharts.TYPE.area&&null!=t.data[c-1]){var m=a+i-(t.data[c-1]-n)/r*i;p.push({y:m,x:h,index:c,startIndex:d})}else p.push({y:Number.NEGATIVE_INFINITY,x:h,index:c,startIndex:-1});d=-1}l=simplify(p,1,!1),o.drawFilteredPoints(l,t,a,i)}else{var x=0,u=0;l=t.filtered;for(var c=0;c<l.length;c++)if(l[c].index>=o.startIndex&&l[c].index<=o.stopIndex){x=c;break}for(var c=l.length-1;c>=0;c--)if(l[c].index<=o.stopIndex){u=c+1;break}x=Math.max(0,x-1),u=Math.min(u+1,l.length-1),l=l.slice(x,u),l.forEach(function(t){t.x=(o.xAxis.values[t.index]-o.xAxis.values[o.startIndex])/o.xAxis.total*o.canvasWidth}),o.drawFilteredPoints(l,t,a,i)}if(o.ctx.stroke(),t.type===AnalysisCharts.TYPE.area&&(o.ctx.fillStyle=t.fillColor,o.ctx.fill(),o.ctx.fillStyle=null),o.showAverages){o.ctx.beginPath(),o.ctx.setLineDash([5,15]);var m=a+i-(t.avg-n)/r*i;o.ctx.moveTo(0,m),o.ctx.lineTo(o.canvasWidth,m),o.ctx.stroke(),o.ctx.setLineDash([])}if(t.id==AnalysisCharts.IDS.speed&&o.markers.racepace){o.ctx.strokeStyle=CommonHelpers.chartLineColors.racePace,o.ctx.beginPath(),o.ctx.setLineDash([5,2,1,2]);var m=a+i-(o.markers.racepace.speed-n)/r*i;o.ctx.moveTo(0,m),o.ctx.lineTo(o.canvasWidth,m),o.ctx.stroke(),o.ctx.setLineDash([]),o.ctx.strokeStyle=t.color}},SuperGraph.prototype.drawFilteredPoints=function(t,e,s,a){var i=this;if(t)for(var r=-1,n=0;n<t.length;n++)if(e.type===AnalysisCharts.TYPE.area){if(r===-1?t[n].y!=Number.NEGATIVE_INFINITY&&(r=t[n].startIndex,i.ctx.moveTo(t[n].x,t[n].y)):t[n].y!=Number.NEGATIVE_INFINITY&&i.ctx.lineTo(t[n].x,t[n].y),t[n+1]){if(t[n].startIndex!==-1&&t[n+1].startIndex!=t[n].startIndex){var o=Math.max(t[n].startIndex,i.startIndex),h=(i.xAxis.values[o]-i.xAxis.values[i.startIndex])/i.xAxis.total*i.canvasWidth;i.ctx.lineTo(t[n].x,s+a),i.ctx.lineTo(h,s+a),i.ctx.closePath(),i.ctx.stroke(),i.ctx.fillStyle=e.fillColor,i.ctx.fill(),i.ctx.fillStyle=null,i.ctx.beginPath(),r=-1}}else if(t[n].startIndex!==-1){var o=Math.max(t[n].startIndex,i.startIndex),h=(i.xAxis.values[o]-i.xAxis.values[i.startIndex])/i.xAxis.total*i.canvasWidth;i.ctx.lineTo(t[n].x,s+a),i.ctx.lineTo(h,s+a),i.ctx.closePath(),i.ctx.stroke(),i.ctx.fillStyle=e.fillColor,i.ctx.fill(),i.ctx.fillStyle=null,i.ctx.beginPath(),r=-1}}else r===-1?t[n].y!=Number.NEGATIVE_INFINITY?(r=t[n].startIndex,i.ctx.moveTo(t[n].x,t[n].y)):r=-1:t[n].y!=Number.NEGATIVE_INFINITY?i.ctx.lineTo(t[n].x,t[n].y):r=-1},SuperGraph.prototype.draw=function(t){var e=0,s=this.marginBetween;this.ctx.clearRect(0,0,this.c.width,this.c.height),this.ctx.fillStyle=CommonHelpers.backgroundColor,this.ctx.fillRect(0,0,this.c.width,this.c.height),this.ctx.fillStyle="black",this.ctx.font="10px Arial",this.ctx.lineWidth=.8;var a=this;if(a.drawMarkers(),this.markersType===SuperGraph.MARKER.phase&&this.datasets.forEach(function(t){if(t.show){var e=t.max-t.min,i=t.showZones?a.chartHeightWithZones:a.chartHeightWithoutZones;t.showPhases&&t.phases&&t.phases.forEach(function(r){if(r.from>=t.min&&r.from<=t.max||r.to>=t.min&&r.to<=t.max||r.from<t.min&&r.to>t.max){var n=(Math.min(t.max,r.to)-Math.max(t.min,r.from))/e*i,o=i-(Math.min(t.max,r.to)-t.min)/e*i,h=(Math.max(a.options.timeBased?r.start.time:r.start.distance,a.xAxis.values[a.startIndex])-a.xAxis.values[a.startIndex])/a.xAxis.total*a.canvasWidth,l=(Math.min(a.options.timeBased?r.stop.time:r.stop.distance,a.xAxis.values[a.stopIndex])-a.xAxis.values[a.startIndex])/a.xAxis.total*a.canvasWidth;a.ctx.fillStyle=r.color,a.ctx.fillRect(h,s+o,l-h,n)}}),s+=i+2*a.marginBetween}}),s=a.marginBetween,this.ctx.strokeStyle=CommonHelpers.textColorSecondary,this.datasets.forEach(function(t){if(t.show){var e=t.max-t.min,i=t.showZones?a.chartHeightWithZones:a.chartHeightWithoutZones;t.showZones&&t.zones&&t.zones.forEach(function(r,n){if(r.from>=t.min&&r.from<=t.max||r.to>=t.min&&r.to<=t.max||r.from<t.min&&r.to>t.max){var o=(Math.min(t.max,r.to)-Math.max(t.min,r.from))/e*i,h=i-(Math.min(t.max,r.to)-t.min)/e*i;a.ctx.fillStyle=r.color,a.ctx.fillRect(0,s+h,15,o),t.showPhases?(a.ctx.fillStyle=AnalysisHelpers.addAlpha(r.color,.05),a.ctx.fillRect(15,s+h,a.c.width,o)):(a.ctx.fillStyle=r.acolor,a.ctx.fillRect(15,s+h,a.c.width,o)),a.ctx.strokeStyle="#E2E2E2",a.ctx.beginPath(),0===n&&(a.ctx.moveTo(0,s+.5),a.ctx.lineTo(a.canvasWidth,s+.5)),a.ctx.moveTo(0,s+h+o+.5),a.ctx.lineTo(a.canvasWidth,s+h+o+.5),a.ctx.closePath(),a.ctx.stroke()}}),s+=i+2*a.marginBetween}}),s=a.marginBetween,this.ctx.fillStyle="black",this.ctx.strokeStyle=CommonHelpers.textColorSecondary,t)$("#"+a.id+" > .supergraph-middle > .supergraph-canvas-bottom").html("&nbsp;");else{a.xAxis.labels=[];var i=a.canvasWidth<600?5:7;if(a.options.timeBased){for(var r=a.xAxis.total,n=AnalysisHelpers.getDefaultXAxisIntervalDuration(r),o=r/n;o>i;)n*=2,o=r/n;for(var h=a.timestamps[a.startIndex],l=1;h<=a.timestamps[a.stopIndex];){var p=DateUtils.millisToThreeDigitTime(h-a.timestamps[a.minIndex]),e=(h-a.timestamps[a.startIndex])/a.xAxis.total*a.canvasWidth;a.xAxis.labels.push({number:l,value:h,title:p,x:e}),h+=n,l++}}else{var d=a.distances[a.stopIndex]-a.distances[a.startIndex],n=AnalysisHelpers.getDefaultXAxisIntervalDistance(d);a.options.metricUnits||(n*=CommonHelpers.oneMileAsKm);for(var o=d/n;o>i;)n*=2,o=d/n;for(var c=a.distances[a.startIndex],l=1;c<=a.distances[a.stopIndex];){var e=(c-a.xAxis.values[a.startIndex])/a.xAxis.total*a.canvasWidth,p=a.xAxis.datasets.DISTANCE.format(c-a.distances[a.minIndex]);a.xAxis.datasets.DISTANCE.unit&&(p+=" "+a.xAxis.datasets.DISTANCE.unit),a.xAxis.labels.push({number:l,value:c,title:p,x:e}),c+=n,l++}}s=a.marginBetween,a.ctx.beginPath(),a.xAxis.labels.forEach(function(t){a.ctx.moveTo(t.x-.5,0),a.ctx.lineTo(t.x-.5,a.canvasHeight)}),a.ctx.closePath(),a.ctx.stroke();var m=_.template($("#templateXAxisLabels").html()),x=m({labels:a.xAxis.labels});$("#"+a.id+" > .supergraph-middle > .supergraph-canvas-bottom").html(x)}a.ctx.beginPath(),this.ctx.strokeStyle=CommonHelpers.reportsLabelsColor,this.ctx.lineWidth=1,a.ctx.moveTo(.5,0),a.ctx.lineTo(.5,a.canvasHeight),a.ctx.moveTo(a.canvasWidth-.5,0),a.ctx.lineTo(a.canvasWidth-.5,a.canvasHeight),a.ctx.moveTo(0,.5),a.ctx.lineTo(a.canvasWidth,.5),a.datasets.forEach(function(t){if(t.show){var e=t.showZones?a.chartHeightWithZones:a.chartHeightWithoutZones;a.ctx.moveTo(0,s+e+a.marginBetween-.5),a.ctx.lineTo(a.canvasWidth,s+e+a.marginBetween-.5),s+=e+2*a.marginBetween}}),a.ctx.closePath(),a.ctx.stroke(),this.ctx.lineWidth=.8,this.ctx.lineJoin="miter",this.ctx.miterLimit=3,this.ctx.strokeStyle=CommonHelpers.textColorSecondary,s=a.marginBetween,this.datasets.forEach(function(e){if(e.show){var i=a.stopIndex-a.startIndex,r=e.max-e.min,n=e.showZones?a.chartHeightWithZones:a.chartHeightWithoutZones;e.children?(e.children.forEach(function(o){o.show&&o.data&&(a.ctx.save(),a.ctx.beginPath(),a.ctx.rect(0,s-a.ctx.lineWidth,a.canvasWidth,n+2*a.ctx.lineWidth),a.ctx.closePath(),a.ctx.clip(),a.ctx.beginPath(),a.ctx.strokeStyle=o.color,a.drawSingle(o,t,i,s,n,r,e.min),a.ctx.restore())}),s+=n+2*a.marginBetween):(a.ctx.save(),a.ctx.beginPath(),a.ctx.rect(0,s-a.ctx.lineWidth,a.canvasWidth,n+2*a.ctx.lineWidth),a.ctx.closePath(),a.ctx.clip(),a.ctx.beginPath(),a.drawSingle(e,t,i,s,n,r,e.min),s+=n+2*a.marginBetween,a.ctx.restore())}}),a.drawLabels(),a.drawYAxisLabels(),a.drawZoneBars()},SuperGraph.prototype.selectionChanged=function(){this.xAxis.total=this.xAxis.values[this.stopIndex]-this.xAxis.values[this.startIndex],this.rangeSlider.slider("values",0,this.startIndex),this.rangeSlider.slider("values",1,this.stopIndex),this.calculateZones(),this.resetMinMax(),this.draw(!1);var t=new Range(this.startIndex,this.stopIndex,this.timestamps[this.startIndex],this.timestamps[this.stopIndex],this.selectedLapIndex);this.selectedLapIndex===-1&&(this.customLapText=null),this.rangeStatistics.update(),$.dispatcher.trigger("superGraph.rangeChanged",{range:t,distanceSamplesOffset:this.distanceSamplesOffset})},SuperGraph.prototype.rangeChanged=function(t){this.xAxis.total=this.xAxis.values[this.stopIndex]-this.xAxis.values[this.startIndex],this.draw(!0);var e=new Range(this.startIndex,this.stopIndex,this.timestamps[this.startIndex],this.timestamps[this.stopIndex],this.selectedLapIndex,t);this.selectedLapIndex===-1&&(this.customLapText=null),this.rangeStatistics.update(),$.dispatcher.trigger("superGraph.rangeChanged",{range:e,distanceSamplesOffset:this.distanceSamplesOffset})},SuperGraph.prototype.bindEvents=function(){var t=this;this.canvas.on("mousedown",function(e){t.dragStart=e.offsetX,t.dragStop=t.dragStart});var e=function(e){if(t.selection.hide(),t.selectedLapIndex=-1,Math.abs(t.dragStart-t.dragStop)>1){if(t.dragStart>=0&&t.dragStop>=0){var s=t.getIndex(t.dragStart-t.canvasLeft),a=t.getIndex(t.dragStop-t.canvasLeft);t.dragStart<=t.dragStop?(t.startIndex=s,t.stopIndex=a):(t.startIndex=a,t.stopIndex=s)}}else t.startIndex=t.minIndex,t.stopIndex=t.maxIndex;t.dragStart=-1,t.dragStop=-1,t.hideTooltip(),t.selectionChanged()},s=function(e){t.canvasLabels.hide(),t.rangeSliderTooltip.is(":visible")||(e=Math.max(0,e),t.dragStart!=-1&&(t.dragStop=e),t.showTooltip(e,!0))};$(document).on("mouseup",function(s){t.dragStart!=-1&&t.dragStop!=-1&&e(s.offsetX)}),this.canvas.mousemove(function(t){s(t.offsetX)}),$("#"+this.id).mouseout(function(e){t.dragStart!==-1||t.dragStop!==-1||t.rangeSliderActive||t.hideTooltip()}),this.$left.on("mousemove touchmove",function(t){s(0)}),this.right.on("mousemove touchmove",function(e){s(t.canvasWidth)}),this.canvas.on("touchmove touchstart",function(e){var a=event.touches[0].pageX-t.marginLeft-20;a<0?a=0:a>t.canvasRight&&(a=t.canvasRight),s(a)}),$.dispatcher.on("laps.selectLapType",function(e,s){if(t.markers.laps=[],$("#"+this.id+" > .supergraph-middle > .supergraph-markers").html(""),s.type===Laps.lapType.perfTest){var a=store.getPerformanceTestData();if(a.length>0)for(var i=a[0].subperiods,r=i.length,n=0;n<r;n++)t.markers.laps.push({number:n+1,start:{time:i[n].startTime.localDateTime,distance:t.parent.getDistanceByTime(i[n].startTime.localDateTime)},stop:{time:i[n].endTime.localDateTime,distance:t.parent.getDistanceByTime(i[n].endTime.localDateTime)},time:i[n].endTime.localDateTime,distance:t.parent.getDistanceByTime(i[n].endTime.localDateTime),x:0,type:SuperGraph.MARKER.lap})}else if(laps&&s.lapDataValues)for(var o=s.lapDataValues.length,n=0;n<o;n++)t.markers.laps.push({number:n+1,start:{time:s.lapDataValues[n].startTime,distance:s.lapDataValues[n].startDistance},stop:{time:s.lapDataValues[n].stopTime,distance:s.lapDataValues[n].stopDistance},time:s.lapDataValues[n].stopTime,distance:s.lapDataValues[n].stopDistance,x:0,type:SuperGraph.MARKER.lap});switch(t.markerTypes=[],t.markers.multisport&&t.markers.multisport.length>0&&t.markerTypes.push({id:SuperGraph.MARKER.multisport,label:Messages["settings.sport_profiles.display_item_category.multisport"],show:!1}),t.markers.swimming&&t.markers.swimming.length>0&&t.markerTypes.push({id:SuperGraph.MARKER.swimming,label:Messages["diary.result.swimming_indoor.swimming_phases"],show:!0}),t.markers.phases&&t.markers.phases.length>0&&t.markerTypes.push({id:SuperGraph.MARKER.phase,label:Messages["analyseview.graph.settings.phases"],show:!0}),t.markers.laps&&t.markers.laps.length>0&&t.markerTypes.push({id:SuperGraph.MARKER.lap,label:Messages["analyseview.laps"],show:!0}),t.markerTypes.length>0&&(t.markerTypes.push({id:SuperGraph.MARKER.off,label:Messages["bikepower.analysisview.graph.settings.show.zones_Off"],show:!0}),t.markersType=t.markerTypes[0].id),s.type){case Laps.lapType.generated:case Laps.lapType.manual:case Laps.lapType.auto:case Laps.lapType.hills:t.markersType=SuperGraph.MARKER.lap;break;case Laps.lapType.swimming:t.markersType=SuperGraph.MARKER.swimming;break;case Laps.lapType.phases:t.markersType=SuperGraph.MARKER.phase}t.selectedLapIndex=-1,t.startIndex=t.minIndex,t.stopIndex=t.maxIndex,t.rangeStatistics.hide(),t.selectionChanged(),t.drawSettings(),t.drawMarkers()}.bind(this)),$.dispatcher.on("laps.selectLap",function(e,s){if(s.selectionRange&&(s.customLapText?t.customLapText=s.customLapText:t.customLapText=null,t.selectedLapIndex=s.selectedLapIndex,s.selectionRange)){switch(s.type.name){case"swimming":s.selectionRange.isDurationBased?(t.startIndex=t.parent.getIndexByTime(s.selectionRange.start,!1),t.stopIndex=t.parent.getIndexByTime(s.selectionRange.stop,!1)):(t.startIndex=t.parent.getIndexByDistance(s.selectionRange.start,!0)+1,t.stopIndex=t.parent.getIndexByDistance(s.selectionRange.stop,!1)-1);break;default:s.selectionRange.startIndex>=0&&s.selectionRange.stopIndex>=0?(t.startIndex=s.selectionRange.startIndex,t.stopIndex=s.selectionRange.stopIndex):s.selectionRange.isDurationBased?(t.startIndex=t.parent.getIndexByTime(s.selectionRange.start,!1),t.stopIndex=t.parent.getIndexByTime(s.selectionRange.stop,!1)):(t.startIndex=t.parent.getIndexByDistance(s.selectionRange.start,!0),t.stopIndex=t.parent.getIndexByDistance(s.selectionRange.stop,!1))}t.selectionChanged()}}.bind(this)),$.dispatcher.on("laps.selectSwimmingPhase",function(e,s){var a=s.swimmingPhaseIndex+1,i=-1;if(null!=s){for(var r=0;r<t.markers.swimming.length;r++)if(t.markers.swimming[r].number===a){i=r;break}i>=0&&(t.customLapText=t.markers.swimming[i].number+" "+t.markers.swimming[i].label,t.selectedLapIndex=Number.MAX_VALUE,t.startIndex=Math.max(t.minIndex,t.markers.swimming[i].start.index),t.stopIndex=Math.min(t.maxIndex,t.markers.swimming[i].stop.index),t.selectionChanged())}else t.customLapText="",t.startIndex=t.minIndex,t.stopIndex=t.maxIndex,t.selectionChanged()}.bind(this)),$.dispatcher.on("laps.unselectLap",function(e,s){t.selectedLapIndex=-1,t.startIndex=t.minIndex,t.stopIndex=t.maxIndex,t.selectionChanged()}.bind(this)),$(window).resize(function(){t.resizeTimeout&&(clearTimeout(t.resizeTimeout),t.resizeTimeout=null),t.resizeTimeout=setTimeout(function(){t.resize()},300)}),$(".supergraph-label").on("click",function(e){e.preventDefault(),t.showOrHideChart($(this).data("id"))?$(this).removeClass("disabled"):$(this).addClass("disabled")}),$.dispatcher.on("sportList.selectSport",function(e,s){var a=s.exercise;t.options.selectedExercise=a.id;for(var i=-1,r=-1,n=0;n<t.timestamps.length;n++)if(t.timestamps[n]>=a.startTime){i=n;break}for(var n=t.timestamps.length-1;n>=0;n--)if(t.timestamps[n]<=a.stopTime){r=n;break}null!==s.exercise.distanceBasedSamples||t.options.timeBased||(t.options.timeBased=!0),t.options.timeBased?t.xAxis.values=t.timestamps:t.xAxis.values=t.distances,t.rangeSlider.slider("option","min",i),t.rangeSlider.slider("option","max",r),t.minIndex=i,t.maxIndex=r,t.startIndex=i,t.stopIndex=r,t.showChartsWithData(),t.selectionChanged(),t.options.speedUnits=a.sportTypeSpeed?"SPEED":"PACE","METRIC"===CommonHelpers.units?t.options.metricUnits=!0:t.options.metricUnits=!1,a.swimmingSport&&(t.options.speedUnits="SWIMMING",a.hasSwimmingSamples&&(t.options.timeBased=!1),a.hasSwimmingSamples&&a.poolUnits&&("METERS"===a.poolUnits?t.options.metricUnits=!0:t.options.metricUnits=!1))}.bind(this)),$.dispatcher.on("sportList.unselectSport",function(e,s){t.options.selectedExercise=-1,"METRIC"===CommonHelpers.units?t.options.metricUnits=!0:t.options.metricUnits=!1,t.options.speedUnits="SPEED",t.options.timeBased=!0,t.xAxis.values=t.timestamps,t.minIndex=0,t.maxIndex=t.timestamps.length-2,t.startIndex=t.minIndex,t.stopIndex=t.maxIndex,t.markersType=SuperGraph.MARKER.multisport,t.showChartsWithData(),t.rangeSlider.slider("option","min",t.startIndex),t.rangeSlider.slider("option","max",t.stopIndex),t.clearMarkers(),t.selectionChanged()}.bind(this)),$(".js-supergraph-fullscreen-button").on("click",function(e){e.preventDefault(),t.toggleFullScreen()}),t.rangeStatistics.bindEvents(),$.dispatcher.on("rangeStatistics.hide",function(e,s){t.startIndex=t.minIndex,t.stopIndex=t.maxIndex,t.selectedLapIndex=-1,t.selectionChanged()}),$.dispatcher.on("rangeStatistics.prev",function(e,s){if(e.preventDefault(),t.selectedLapIndex>=0)switch(t.markersType){case SuperGraph.MARKER.lap:t.markers.laps&&t.markers.laps.length>0&&t.selectedLapIndex>0&&(t.selectedLapIndex--,t.selectLap(t.selectedLapIndex+1));break;case SuperGraph.MARKER.phase:t.markers.phases&&t.markers.phases.length>0&&t.selectedLapIndex>0&&(t.selectedLapIndex--,t.selectPhase(t.selectedLapIndex+1))}}),$.dispatcher.on("rangeStatistics.next",function(e,s){if(e.preventDefault(),t.selectedLapIndex>=0)switch(t.markersType){case SuperGraph.MARKER.lap:t.markers.laps&&t.markers.laps.length>0&&t.selectedLapIndex<t.markers.laps.length-1&&(t.selectedLapIndex++,t.selectLap(t.selectedLapIndex+1));break;case SuperGraph.MARKER.phase:if(t.markers.phases&&t.markers.phases.length>0){for(var a=0,i=0;i<t.markers.phases.length;i++)t.markers.phases[i].showNumber&&t.markers.phases[i].number&&(a=t.markers.phases[i].number-1);t.selectedLapIndex<a&&(t.selectedLapIndex++,t.selectPhase(t.selectedLapIndex+1))}}})},SuperGraph.prototype.resize=function(){var t=this,e=t.wrapper[0].offsetWidth-t.wrapper[0].clientWidth;t.wrapper.find(".supergraph").css("margin-right",e+"px"),t.setRightMargins(),t.canvasWidth=t.wrapper.width()-t.marginLeft-t.marginRight-e,t.canvas[0].width=t.canvasWidth,t.canvasLeft=t.canvas.position().left,t.markersContainer.css("left",t.canvasLeft+"px"),t.canvasLabels.css("width",t.canvasWidth+"px"),t.canvasRight=t.canvasLeft+t.canvasWidth,t.setMargins(),t.draw(!1)},SuperGraph.prototype.hideTooltip=function(){this.tooltip.hide(),this.selection.hide(),this.crosshair.hide(),this.canvasLabels.show(),$.dispatcher.trigger("superGraph.tooltip",{index:-1})},SuperGraph.prototype.showTooltip=function(t,e){var s=this.getIndex(t),a=this.getTooltipElements(s,t,e),i=_.template($("#templateTooltip").html());if(this.tooltip.html(i({tooltips:a})),this.tooltip.css("transform","translate("+(t-this.tooltip.width()/2)+"px, 0px)"),t>this.canvasWidth-this.tooltip.width()/2?this.tooltip.find(".supergraph-tooltips").addClass("supergraph-tooltips__align-right"):this.tooltip.find(".supergraph-tooltips").removeClass("supergraph-tooltips__align-right"),this.crosshair.css("left",t-1),this.dragStart!=-1){var r=Math.abs(t-this.dragStart);this.selection.css({left:Math.min(t,this.dragStart),width:r+"px",display:"block"})}this.tooltip.show(),this.crosshair.show(),$.dispatcher.trigger("superGraph.tooltip",{index:s,offsetX:t,timestamp:this.timestamps[s],distance:this.distances?this.distances[s]:null,distanceSamplesOffset:this.distanceSamplesOffset})},SuperGraph.prototype.showOrHideChart=function(t){for(var e=this,s=0;s<this.datasets.length;s++)if(this.datasets[s].id===t)return this.datasets[s].show=!this.datasets[s].show,e.updateCanvasHeight(!1),this.datasets[s].show},SuperGraph.prototype.setMargins=function(){this.marginTop=30,this.canvasTop=this.marginTop,this.canvas.css("margin-top","30px"),this.canvasLabels.css("width",this.canvasWidth+"px"),this.canvasLabels.css("top",this.canvasTop+"px"),this.$left.css("padding-top",this.marginTop+"px"),this.markersContainer.css("left",this.canvasLeft+"px"),this.markersContainer.css("width",this.canvasWidth+"px"),this.right.css("padding-top",this.marginTop+this.marginBetween+"px"),this.crosshair.css("top",this.canvasTop+"px"),this.selection.css("top",this.canvasTop+"px"),this.tooltip.css("top",this.canvasTop+"px"),this.controls.css("top",this.canvasTop+"px")},SuperGraph.prototype.setRightMargins=function(){for(var t=!1,e=0;e<this.datasets.length;e++)if(this.datasets[e].show&&this.datasets[e].showZones){t=!0;break}var s=0;if((s=this.right.is(":visible")?t?this.options.fullscreen?248:235:this.options.fullscreen?30:60:20)!=this.marginRight){this.marginRight=s;var a=$("#"+this.id).parent().width()-this.marginLeft-this.marginRight;this.canvasWidth=a,this.canvasRight=this.canvasLeft+this.canvasWidth,this.c.width=this.canvasWidth,this.right.css("width",this.marginRight+"px")}},SuperGraph.prototype.drawLabels=function(){this.setMargins();var t=[],e=this.marginBetween/2,s=this;this.datasets.forEach(function(a){if(a.show){var i=a.showZones?s.chartHeightWithZones:s.chartHeightWithoutZones,r={y:e,label:a.label,unit:a.unit};t.push(r),e+=i+2*s.marginBetween}});var a=_.template($("#templateCanvasLabels").html());this.canvasLabels.html(a({labels:t}))},SuperGraph.prototype.drawYAxisLabels=function(){if($("#"+this.id+" > .supergraph-left").length>1);else{var t=_.template($("#templateYAxisLabels").html()),e=[],s=0,a=this;this.datasets.forEach(function(t){if(t.show){var i=[],r=t.showZones?a.chartHeightWithZones:a.chartHeightWithoutZones,n=t.max-t.min;if(t.yAxis.labels.forEach(function(e){e.value>=t.min&&e.value<=t.max&&(e.y=s+(r-(e.value-t.min)/n*r),i.push(e))}),0===i.length){var o=t.yAxis.maxLabel;o.value>=t.min&&o.value<=t.max&&(o.y=s+(r-(o.value-t.min)/n*r),i.push(o));var h=t.yAxis.minLabel;h.value>=t.min&&h.value<=t.max&&(h.y=s+(r-(h.value-t.min)/n*r),i.push(h))}var l={height:r+2*a.marginBetween,canvasYPos:s-a.marginBetween,labels:i,color:t.color};e.push(l),s+=r+2*a.marginBetween}}),$("#"+this.id+" > .supergraph-left").html(t({labelGroups:e,marginBetween:a.marginBetween}))}},SuperGraph.prototype.drawMarkers=function(){var t=this,e=[];if(t.markers.racepace){var s=t.markers.racepace,a=(t.options.timeBased?s.time:s.distance)-t.xAxis.values[t.startIndex]
;s.x=t.canvasRight-(t.canvasLeft+a/t.xAxis.total*t.canvasWidth),e.push(s)}if(this.markersEnabled)switch(this.markersType){case SuperGraph.MARKER.multisport:this.markers.multisport&&this.markers.multisport.length>0&&(this.markers.multisport.forEach(function(e){var s=t.options.timeBased?e.start.time:e.start.distance;if(null!=s){var a=s-t.xAxis.values[t.startIndex];if(e.x=t.canvasLeft+a/t.xAxis.total*t.canvasWidth,e.stop){var i=(t.options.timeBased?e.stop.time:e.stop.distance)-t.xAxis.values[t.startIndex],r=t.canvasLeft+i/t.xAxis.total*t.canvasWidth;e.width=r-e.x}}else e.x=Number.NEGATIVE_INFINITY}),e=e.concat(this.markers.multisport));break;case SuperGraph.MARKER.phase:if(this.markers.phases&&this.markers.phases.length>0){var i=1;this.markers.phases.forEach(function(e){var s=(t.options.timeBased?e.time:e.distance)-t.xAxis.values[t.startIndex];e.x=t.canvasLeft+s/t.xAxis.total*t.canvasWidth,e.showNumber&&(e.number=i,i++)}),e=e.concat(this.markers.phases)}break;case SuperGraph.MARKER.lap:if(this.markers.laps){for(var r=0;r<this.markers.laps.length;r++){var a,n=this.markers.laps[r];a=this.options.timeBased?n.time-this.xAxis.values[this.startIndex]:n.distance-(this.xAxis.values[this.startIndex]-this.xAxis.values[this.minIndex]),this.markers.laps[r].x=a/this.xAxis.total*this.canvasWidth}e=e.concat(this.markers.laps)}break;case SuperGraph.MARKER.swimming:this.markers.swimming&&this.markers.swimming.length>0&&(this.markers.swimming.forEach(function(e){if(e.isRestTime&&!t.options.timeBased)e.startX=-1e3,e.stopX=-1e3;else{var s=(t.options.timeBased?e.start.time:e.start.distance)-t.xAxis.values[t.startIndex],a=(t.options.timeBased?e.stop.time:e.stop.distance)-t.xAxis.values[t.startIndex];e.startX=t.canvasLeft+s/t.xAxis.total*t.canvasWidth,e.stopX=t.canvasLeft+a/t.xAxis.total*t.canvasWidth}}),e=e.concat(this.markers.swimming))}if(e&&e.length>0){if($("#"+this.id+" > .supergraph-middle > .supergraph-markers > .supergraph-marker").length!==e.length){var o=_.template($("#templateMarkers").html());$("#"+this.id+" > .supergraph-middle > .supergraph-markers").html(o({markers:e,canvasHeight:this.canvasHeight})),$(".supergraph-marker__racepace").on("click",function(){var e=-1,s=-1;t.options.timeBased?(e=t.minIndex,s=t.parent.getIndexByTime(t.markers.racepace.time,!1)):(e=t.minIndex,s=t.parent.getIndexByDistance(t.markers.racepace.distance,!0)),e>=0&&s>=0&&(t.startIndex=e,t.stopIndex=s,t.selectionChanged())}),$("#"+this.id+" > .supergraph-middle > .supergraph-markers > .supergraph-marker > .supergraph-marker__number").on("click",function(e){e.preventDefault();var s=$(this).data("type"),a=$(this).data("value");if(null!=s&&null!=a)switch(s){case SuperGraph.MARKER.lap:t.selectLap(a);break;case SuperGraph.MARKER.phase:t.selectPhase(a);break;case SuperGraph.MARKER.swimming:t.selectSwimmingPhase(a)}})}var t=this,h=t.canvasRight+1,l=t.canvasLeft-1;this.markersType===SuperGraph.MARKER.swimming?$("#"+this.id+" > .supergraph-middle > .supergraph-markers > .supergraph-marker").each(function(){var t=$(this).data("index");$(this).attr("data-number")?e[t].stopX>=l&&e[t].stopX<=h?($(this).css("transform","translate("+e[t].stopX+"px, 0px)"),$(this).show()):$(this).hide():e[t].startX>=l&&e[t].startX<=h?($(this).css("transform","translate("+e[t].startX+"px, 0px)"),$(this).show()):$(this).hide()}):$("#"+this.id+" > .supergraph-middle > .supergraph-markers > .supergraph-marker").each(function(t){if(e[t].type===SuperGraph.MARKER.multisport&&e[t].width)$(this).css("width",e[t].width),e[t].x>=l&&e[t].x+e[t].width<=h?($(this).css("transform","translate("+e[t].x+"px, 0px)"),$(this).show()):$(this).hide();else if(e[t].x>=l&&e[t].x<=h){if(e[t].alignRight){var s=e[t].x;$(this).css("transform","translate("+-s+"px, 0px)")}else $(this).css("transform","translate("+e[t].x+"px, 0px)");$(this).show()}else $(this).hide()})}else $("#"+this.id+" > .supergraph-middle > .supergraph-markers").html("")},SuperGraph.prototype.selectLap=function(t){for(var e=0;e<this.markers.laps.length;e++)if(this.markers.laps[e].number===t){var s=-1,a=-1;this.options.timeBased?(s=this.parent.getIndexByTime(this.markers.laps[e].start.time,!0),a=this.parent.getIndexByTime(this.markers.laps[e].stop.time,!0)):(s=this.parent.getIndexByDistance(this.markers.laps[e].start.distance,!1),a=this.parent.getIndexByDistance(this.markers.laps[e].stop.distance,!0)),s>=0&&a>=0&&(this.startIndex=s,this.stopIndex=a,this.selectionChanged(),$.dispatcher.trigger("superGraph.selectLap",{index:t-1}))}},SuperGraph.prototype.selectPhase=function(t){$.dispatcher.trigger("superGraph.selectPhase",{index:t-1})},SuperGraph.prototype.selectSwimmingPhase=function(t){$.dispatcher.trigger("superGraph.selectSwimmingPhase",{index:t-1})},SuperGraph.prototype.drawZoneBars=function(){var t=_.template($("#templateZoneBars").html()),e=[],s=this,a=0;this.datasets.forEach(function(t){if(t.show){if(t.showZones){var i=[];t.zones&&(t.zones.forEach(function(t){i.push(t)}),e.push({top:a,zones:i.reverse(),label:s.zoneGroups[t.zoneIds[t.zoneIndex]].label}))}a+=(t.showZones?s.chartHeightWithZones:s.chartHeightWithoutZones)+2*s.marginBetween}}),this.right.is(":visible")?($("#zonesAtBottom").html(""),this.right.html(t({zoneGroups:e,showAtBottom:!1})),$("#zonesAtBottom").hide()):(this.right.html(""),$("#zonesAtBottom").html(t({zoneGroups:e,showAtBottom:!0})),$("#zonesAtBottom").show())},SuperGraph.prototype.formatUnitsAndLabels=function(){var t=this;t.datasets.forEach(function(t){t.children&&t.children.forEach(function(t){t.unit=t.formatUnit(),"function"==typeof t.formatLabelText&&(t.label=t.formatLabelText()),"function"==typeof t.formatAvgLabelText&&(t.avgLabel=t.formatAvgLabelText())}),t.unit=t.formatUnit(),"function"==typeof t.formatLabelText&&(t.label=t.formatLabelText()),"function"==typeof t.formatAvgLabelText&&(t.avgLabel=t.formatAvgLabelText())});for(var e in t.xAxis.datasets){var s=t.xAxis.datasets[e];s.unit=s.formatUnit()}},SuperGraph.prototype.resetMinMax=function(){var t=this,e=0;t.datasets.forEach(function(s){var a=[];if(s.max=Number.NEGATIVE_INFINITY,s.min=Number.MAX_VALUE,s.total=0,s.avg=0,s.showZones&&s.zones&&t.startIndex===t.minIndex&&t.stopIndex>=t.maxIndex){t.updateDatasetMinMax(s,!0);var i=Number.NEGATIVE_INFINITY,r=Number.MAX_VALUE;if(s.zones.forEach(function(t){null==t.to&&(t.to=s.max),null==t.from&&(t.from=s.min),t.to>i&&(i=t.to),"ALTITUDE"==s.id?r=s.min:t.from<r&&(r=t.from)}),s.min=Math.min(r,s.min),s.shrinkLastZone){if(s.zones.length>1){var n=s.zones[s.zones.length-1];if(n.from>s.max){var o=s.zones[s.zones.length-2],h=n.from+(o.to-o.from);s.max=h}}}else s.max=Math.max(i,s.max)}else t.updateDatasetMinMax(s,!1);s.min===s.max&&(s.min-=1,s.max+=1,s.total=s.max-s.min);var l=null!=t.distances?t.distances[t.stopIndex]-t.distances[t.startIndex]:0,p=null!=t.timestamps?t.timestamps[t.stopIndex]-t.timestamps[t.startIndex]:0;if(t.markers.swimming&&t.markers.swimming.length>0&&(p=t.getSwimmingSamplesTotalDuration()),s.children?s.children.forEach(function(t){t.totalSamples=0,t.total=0,t.data&&t.data.forEach(function(e){null==e||t.avgIgnoreZeros&&0===e||(t.total+=e,t.totalSamples++)}),"km_per_hour"===s.avgFormat?t.avg=AnalysisHelpers.metersAndMillisToKilometersPerHour(l,p):t.avg=t.total/t.totalSamples}):(s.totalSamples=0,s.total=0,s.data.forEach(function(t){null==t||s.avgIgnoreZeros&&0===t||(s.total+=t,s.totalSamples++)}),"km_per_hour"===s.avgFormat?s.avg=AnalysisHelpers.metersAndMillisToKilometersPerHour(l,p):s.avg=s.total/s.totalSamples),s.filtered=null,s.showZones){var d=0;a.push({value:s.zones[0].from,title:s.formatLabel(s.zones[0].from),y:0}),s.zones.forEach(function(t){a.push({value:t.to,title:s.formatLabel(t.to),y:0}),d+=t.value}),s.zones.forEach(function(e,s){d>0&&e.value>0?e.percentage=Math.round(e.value/d*100):e.percentage=0,e.number=s+1,t.options.timeBased?e.text=t.xAxis.datasets.DURATION.format(e.value):e.text=t.xAxis.datasets.DISTANCE.format(e.value)+"&nbsp;"+t.xAxis.datasets.DISTANCE.unit})}s.yAxis={},s.yAxis.labels=a,s.yAxis.maxLabel={value:s.max,title:s.formatLabel(s.max),y:0},s.yAxis.minLabel={value:s.min,title:s.formatLabel(s.min),y:0},s.show&&(e+=2*t.marginBetween,e+=s.showZones?t.chartHeightWithZones:t.chartHeightWithoutZones)}),e!=t.canvasHeight&&t.setCanvasHeight(e),t.formatUnitsAndLabels()},SuperGraph.prototype.updateDatasetMinMax=function(t,e){if(t.children){var s=this;t.children.forEach(function(e){if(e.totalSamples=0,e.data)for(var a=s.startIndex;a<=s.stopIndex;a++){var i=e.data[a];null!==i&&(i>t.max&&(t.max=i),i<t.min&&(t.min=i))}})}else if(t.totalSamples=0,t.data){var a=t.max,i=t.min,r=null;"function"==typeof t.minValue&&(r=t.minValue());for(var n=!1,o=this.startIndex;o<=this.stopIndex;o++){var h=t.data[o];if(null!=h){if(0===h&&(n=!0,t.yAxisIgnoreZeros))continue;null===r||h>=r?(a=Math.max(h,a),i=Math.min(h,i)):null!==r&&(i=r)}}n&&(e||!t.yAxisIgnoreZeros||i<t.thresholdToIgnoreZeros)&&(i=Math.min(i,0)),t.max=a,t.min=i}},SuperGraph.prototype.setCanvasHeight=function(t){this.canvasHeight=t,this.c.height=this.canvasHeight,this.canvasLabels.css("height",this.canvasHeight+"px"),this.$left.css("height",this.canvasHeight+"px"),this.right.css("height",this.canvasHeight+"px"),this.markersContainer.css("height",this.canvasHeight+"px"),this.crosshair.css("height",this.canvasHeight+"px"),this.selection.css("height",this.canvasHeight+"px"),$(".supergraph-marker__line").css("height",this.canvasHeight+"px"),$(".supergraph-marker__dashed-line").css("height",this.canvasHeight+"px")},SuperGraph.prototype.filterSingleData=function(t,e,s,a,i){for(var r=0,n=[],o=-1,h=0;h<=t.data.length;h++)if(r=(this.xAxis.values[h]-this.xAxis.values[this.startIndex])/this.xAxis.total*this.canvasWidth,null!=t.data[h]){o===-1&&(o=h);var l=e+s-(t.data[h]-i)/a*s;n.push({y:l,x:r,index:h,startIndex:o})}else{if(h>0)if(t.type!=AnalysisCharts.TYPE.area&&null!=t.data[h-1]){var l=e+s-(t.data[h-1]-i)/a*s;n.push({y:l,x:r,index:h,startIndex:o})}else n.push({y:Number.NEGATIVE_INFINITY,x:r,index:h,startIndex:-1});o=-1}return simplify(n,1,!1)},SuperGraph.prototype.filterData=function(){var t=this,e=t.marginBetween;t.xAxis.total=t.xAxis.values[t.stopIndex]-t.xAxis.values[t.startIndex],t.xAxis.totalHidden=t.xAxis.values[t.maxIndex]-t.xAxis.values[t.minIndex],this.datasets.forEach(function(s){var a=s.showZones?t.chartHeightWithZones:t.chartHeightWithoutZones,i=s.max-s.min;s.shown&&(s.children?(s.children.forEach(function(r){r.filtered=t.filterSingleData(r,e,a,i,s.min)}),e+=a+2*t.marginBetween):(s.filtered=t.filterSingleData(s,e,a,i,s.min),e+=a+2*t.marginBetween))})},SuperGraph.prototype.calculateZones=function(){var t=this;this.datasets.forEach(function(e){if(e.showZones&&e.zones)for(var s=t.startIndex;s<t.stopIndex;s++)e.zones.forEach(function(t){t.value=0,t.percentage=0})}),this.datasets.forEach(function(e){var s=store.getCurveData().combinedHillZoneSamples;if("ALTITUDE"===e.id&&void 0!==s){var a=e.data;e.data=s,t.calculateDatasetZones(e),e.data=a,e.showZones=!0}else"ALTITUDE"===e.id?e.showZones=!1:t.calculateDatasetZones(e)})},SuperGraph.prototype.calculateDatasetZones=function(t){var e=this;if(t.showZones&&t.zones){for(var s=-1,a=0,i=-1,r=e.startIndex;r<=e.stopIndex;r++){for(var n=-1,o=t.zones.length-1;o>=0;o--){var h=t.zones[o];if(t.data[r]>=h.from&&t.data[r]<=h.to){n=o;break}}if(null!=t.data[r]&&i!==-1&&n===i);else{if(s>=0){var l=e.xAxis.values[r]-e.xAxis.values[s];t.zones[i].value+=l,a+=l,s=-1,i=-1}s===-1&&n>=0&&(s=r,i=n)}}if(s>=0){var l=e.xAxis.values[e.stopIndex]-e.xAxis.values[s];t.zones[i].value+=l,a+=l}t.zones.forEach(function(t){a>0&&t.value>0?t.percentage=Math.round(t.value/a*100):t.percentage=0,e.options.timeBased?t.text=e.xAxis.datasets.DURATION.format(t.value):t.text=e.xAxis.datasets.DISTANCE.format(t.value)+"&nbsp;"+e.xAxis.datasets.DISTANCE.unit})}},SuperGraph.prototype.getDatasetIndex=function(t){for(var e=0;e<this.datasets.length;e++)if(this.datasets[e].id===t)return e;return-1},SuperGraph.prototype.updateCanvasHeight=function(t){var e=0;this.datasets.forEach(function(t){t.show&&e++}),this.options.fullscreen||e<2?(this.chartHeightWithZones=210,this.chartHeightWithoutZones=e<2?210:110):(this.chartHeightWithZones=110,this.chartHeightWithoutZones=60);var s=0,a=this;this.datasets.forEach(function(t){t.show&&(s+=2*a.marginBetween,s+=t.showZones?a.chartHeightWithZones:a.chartHeightWithoutZones)}),this.canvasHeight!=s&&this.setCanvasHeight(s),this.filterData(),t?this.resize():this.draw(!1)},SuperGraph.prototype.toggleFullScreen=function(){this.wrapper.hasClass("supergraph-fullscreen")?(this.options.fullscreen=!1,this.setRightMargins(),$(".navigation").show(),$("#graphFullscreenHeader").hide(),this.wrapper.removeClass("supergraph-fullscreen"),this.wrapper.css("overflow-y","visible"),this.wrapper.css("overflow-x","visible"),$("body").attr("style",null)):(this.options.fullscreen=!0,this.setRightMargins(),$(".navigation").hide(),$("#graphFullscreenHeader").show(),this.wrapper.addClass("supergraph-fullscreen"),this.wrapper.css("overflow-y","auto"),this.wrapper.css("overflow-x","hidden"),$("body").css("overflow","hidden")),this.updateCanvasHeight(!0)},SuperGraph.prototype.clearMarkers=function(){$("#"+this.id+" > .supergraph-middle > .supergraph-markers").html("")},SuperGraph.prototype.showChartsWithData=function(){var t=this;t.datasets.forEach(function(e){if(!e.hideByDefault&&e.hasData){for(var s=!1,a=t.startIndex;a<=t.stopIndex;a++)if(null!=e.data[a]){s=!0;break}s?(e.show=!0,$(".supergraph-settings__chart[data-id="+e.id+"]").addClass("active"),$(".supergraph-settings__zone[data-chart="+e.id+"]").removeClass("disabled")):(e.show=!1,$(".supergraph-settings__chart[data-id="+e.id+"]").removeClass("active"),$(".supergraph-settings__zone[data-chart="+e.id+"]").addClass("disabled"))}}),t.updateCanvasHeight(!1)},SuperGraph.prototype.getSwimmingSamplesTotalDuration=function(){if(this.markers.swimming){for(var t=0,e=this.timestamps[this.startIndex],s=this.timestamps[this.stopIndex],a=store.getPhasesData(),i=a[this.options.selectedExercise].phases,r=a[this.options.selectedExercise].startTime,n=0;n<i.length;n++){var o=i[n];if(o.distance>0){var h=r+o.startSplitTime.millis,l=o.duration.millis,p=h+l,d=h>=e&&h<=s||p>=e&&p<=s,c=e>=h&&e<=p,m=s>=h&&s<=p;d&&(c||m?c?t+=p-e:m&&(t+=s-h):t+=l)}}return t}return null};
//# sourceMappingURL=superGraph.min.js.map